# N-SentiTrader 데이터베이스 재백업 요청 지침서

## 1. 배경 (Background)
- **현상:** 2025-12-21 마이그레이션 시도 중 기존 덤프 파일(`n_sentitrader_backup_final.sql`) 복원 실패.
- **원인:**
  1. **호환성 문제:** `pg_dump` 버전(Postgres 16+)과 타겟 시스템(Postgres 15 Docker) 간의 `\restrict` 커맨드 불일치.
  2. **데이터 파싱 오류:** `COPY` 방식 사용 시 텍스트 인코딩/개행문자 처리 문제로 인한 `trailing junk` 에러 (Line 124069).
  3. **스키마 불일치:** 현재 소스 코드(`src/dashboard`)가 참조하는 `intensity` 등의 컬럼이 백업본에 부재.

## 2. 요청 사항 (Requirements)
소스 데이터베이스 관리자에게 아래 옵션을 적용하여 **새로운 덤프 파일** 생성을 요청하십시오.

### 2.1 필수 옵션 (pg_dump Options)
호환성과 안정성을 최우선으로 하기 위해 `COPY` 대신 `INSERT` 방식을 사용하고 권한 정보를 제외합니다.

```bash
pg_dump \
  -h <SOURCE_HOST> \
  -p <SOURCE_PORT> \
  -U <SOURCE_USER> \
  -d nsentitrader \
  --no-owner \
  --no-privileges \
  --clean \
  --if-exists \
  --quote-all-identifiers \
  --inserts \
  --rows-per-insert=1000 \
  --encoding=UTF8 \
  --file=n_sentitrader_rebackup_v1.sql
```

### 2.2 옵션 상세 설명
- `--no-owner`, `--no-privileges`: 타겟 시스템(Docker)의 사용자/권한 체계가 다를 수 있으므로 소유권 정보를 제거합니다.
- `--inserts`, `--rows-per-insert=1000`: `COPY` 구문 대신 표준 SQL `INSERT` 문을 사용하여 파싱 오류를 원천 차단합니다.
- `--clean`, `--if-exists`: 복원 시 기존 객체를 안전하게 삭제하고 재생성합니다.
- `--encoding=UTF8`: 인코딩 호환성을 보장합니다.

## 3. 스키마 동기화 (Schema Sync)
덤프 수행 전, 운영 중인 소스 DB에 다음 컬럼이 존재하는지 반드시 확인해 주십시오. (소스 코드와 DB 간의 Sync)
- Table `tb_predictions`: Column `expected_alpha`, `intensity`, `status`
- Table `daily_targets`: Column `started_at`

만약 없다면, 마이그레이션 대상이 되는 "최신 리비전의 DB"가 맞는지 확인이 필요합니다.
