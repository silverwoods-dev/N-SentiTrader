# N-SentiTrader PRD

## 우선순위 및 지침 준수

- 본 프로젝트에서 에이전트(자동화 도구 포함)가 수행하는 모든 작업은 `/home/dev/stock_words/.github/copilot-instructions.md`의 규칙을 최우선으로 준수해야 합니다.
- 특히 문서·지침·검토 요청 시 기본 커뮤니케이션 언어는 한국어로 하며, 운영 환경은 Docker 컨테이너, 개발 환경은 `uv` 기반의 `venv`를 우선 고려합니다.
- 테스트 계획은 PRD/Tasks 워크플로우에 따라 `docs/tasks/n-sentitrader-tasks.md`의 항목으로 등록하고 실행·검증합니다. 임시 문서는 아카이브 처리 후 TASKS에 링크합니다.


## 1. 개요(Overview)
- **한 줄 요약:** 뉴스 텍스트 마이닝을 통해 단어별 영향력을 수치화한 동적 감성사전을 구축하고, 이를 바탕으로 특정 종목이 익일 시장 대비 초과 수익(Alpha)을 낼지 예측하는 시스템.
- **배경:**
  - 기존 감성 분석의 단순 긍/부정 이분법 한계 극복.
  - 금융 시장 특성을 반영하여 단어의 영향력(Magnitude)과 유효 기간(Time Decay)을 수치화할 필요성.
- **목표:**
  - **동적 감성사전:** 주간 학습(Lasso)과 일간 보정(Buffer)을 결합한 이원화 모델 구축.
  - **초과 수익 예측:** 시장 지수(Benchmark) 대비 초과 수익 여부(Binary Classification) 예측.
  - **신뢰성 확보:** 정교한 데이터 매칭(시장별 지수)과 현실적인 시차 적용(달력일 기준).

## 2. 대상 사용자 및 사용 시나리오
- **주요 사용자:**
  - **시스템 관리자:** 매일 아침 자동 생성된 리포트 정합성 확인, 주간 모델 성능 모니터링.
  - **투자자/트레이더:** 예측 리포트의 '매수' 신호와 근거(Top 3 키워드)를 참고하여 장 시초가 매매 수행.
- **사용 시나리오:**
  - "내일 삼성전자가 KOSPI 지수보다 더 오를지 예측하고 싶다."
  - "최근 '밸류업' 관련 뉴스가 시장에 미치는 긍/부정 점수가 어떻게 변했는지 확인하고 싶다."
  - "주말 동안 발생한 악재가 월요일 장에 얼마나 반영될지 미리 파악하고 싶다."

## 3. 범위(Scope: In / Out)
- **In Scope:**
  - **데이터:** 국내 포털 금융 뉴스(제목, 본문), KOSPI/KOSDAQ 전 종목 OHLCV 및 시장 지수.
  - **핵심 로직:**
    - **N-gram 분석:** 단어(Unigram)뿐만 아니라 구문(Bigram, Trigram) 단위의 감성 분석 수행.
    - **시장 매칭:** KOSPI 종목 ↔ KOSPI 지수, KOSDAQ 종목 ↔ KOSDAQ 지수 비교.
    - **시간 감쇠:** 거래일이 아닌 **달력일(Calendar Day)** 기준 감쇠 적용 (주말 효과 반영).
    - **사용자 사전:** '2차전지', '밸류업' 등 금융 신조어 처리.
  - **인프라:** Docker Container 기반의 독립 실행 환경.
    - **VPN:** Cloudflare WARP (IP Rotation) 적용.
- **Out of Scope:**
  - 실시간 스트리밍 데이터 처리 (Daily Batch로 제한).
  - 해외 주식 및 ETF (초기 버전은 국내 개별 종목 한정).
  - 웹 프론트엔드 개발 (CLI 및 JSON/File 리포트 위주).

## 4. 데이터 모델 및 스키마 설계
PostgreSQL 15+ 기반의 스키마를 사용합니다.

- **주요 테이블:**
  - `tb_stock_master`: 종목 코드, 종목명, 시장 구분(KOSPI/KOSDAQ).
  - `tb_market_index`: 일자, 시장구분, 종가, 등락률.
  - `tb_daily_price`: 일자, 종목코드, OHLCV, 등락률, **초과 수익률(Y)**.
  - `tb_news_content`: 뉴스 원문, 제목 해시(중복방지), **전처리된 토큰(JSONB)**.
  - `tb_news_mapping`: 뉴스ID-종목코드 매핑, **시장 반영일(Impact Date)**.
  - `tb_sentiment_dict`: 단어, 가중치(Beta), 버전(날짜), 소스(Main/Buffer).
- **데이터 원칙:**
  - 원시 텍스트는 최소 3년 보관.
  - **벡터/분석 데이터는 최소 1년 보관.**
  - 학습용(D-7일 이전)과 추론용(최근 7일) 데이터 뷰(View) 분리.
  - **사용자 사전:** `user_dic.csv`는 소스 코드와 분리하여 별도 관리하며, 서버 재기동 없이 로드 가능해야 함.

## 5. 시스템 아키텍처 및 파이프라인
Docker Compose를 통해 App 컨테이너와 DB 컨테이너가 격리된 네트워크에서 통신합니다.

- **Runtime:** Python 3.10-slim (Docker)
- **Database:** PostgreSQL 15-alpine
- **Data Processing:** Polars (대용량 텍스트 고속 처리), Mecab (C++ 기반 고속 형태소 분석)
- **Scheduling:** APScheduler (컨테이너 내부 데몬 스케줄링)
- **Directory Standard:** `/app/data` (영구 저장), `/app/output` (리포트 출력)
- **Pipeline:**
  1. **Collector:** 뉴스/주가 수집 -> 중복 제거 -> DB 적재.
  2. **Learner:** 
     - Weekly: 3개월 데이터 -> Lasso 회귀 -> Main Dictionary.
     - Daily: 3일 데이터 -> 변동성 분석 -> Buffer Dictionary.
  3. **Predictor:** 뉴스 로드 -> 사전 매칭(Time Decay) -> 점수 산출 -> 리포트 생성.

## 6. MCP 도구 사용 전략
- **filesystem:**
  - 프로젝트 구조 탐색 및 파일 읽기/쓰기.
  - **주의:** 대규모 삭제나 구조 변경 시에는 반드시 사용자 승인 후 진행.
- **context7:**
  - 최신 라이브러리(Polars, Scikit-learn 등) 사용법 및 Best Practice 조회.
- **PostgreSQL (Optional):**
  - DB 쿼리 검증 및 스키마 마이그레이션 지원.

## 7. 구현 범위 및 모듈 구조
### 7.1 모듈 A: 데이터 수집기 (Collector)
- **FR-A01:** 포털 금융 뉴스 크롤링 (제목, 본문, 날짜).
  - **[업데이트]** 네이버 뉴스 SDS(Smart Design System) 레이아웃 변경 대응 완료.
  - **[업데이트]** 페이지네이션 제한(20페이지) 우회 로직 적용.
- **FR-A02:** 주가 및 시장 지수(KOSPI/KOSDAQ) 수집.
- **FR-A03:** 뉴스 중복 제거 (유사도 90% 이상).
- **FR-A04:** 학습/추론 데이터셋 분리 뷰 제공.
- **FR-A05:** 타겟 라벨링 (시장 지수 대비 초과 수익 여부).
- **FR-A06:** VPN IP Rotation (대량 수집 시 차단 방지).
- **FR-A07:** 과거 데이터 수집 (Cold Start 해결을 위한 대량 수집 유틸리티).
  - **[추가]** 2년 치(2024~2025) 과거 데이터 수집 및 초기 모델 부트스트랩(Initial Training) 지원.

### 7.2 모듈 B: 학습 및 감성사전 구축기 (Learner)
- **FR-B01:** Mecab 형태소 분석 및 N-gram (1~3) 생성 (단어 및 구문 학습).
- **FR-B02:** Main 모델 학습 (Lasso, 주간, 3개월 데이터).
  - **[기술 스택]** 대용량 텍스트 처리를 위해 **Polars** 라이브러리 필수 사용.
- **FR-B03:** Buffer 모델 학습 (**빈도 상위 10% & 변동성 2배 이상**, 일간, 3일 데이터).
- **FR-B04:** 사전 병합 및 EMA 업데이트.
- **FR-B05:** OOV(미등록 단어) 모니터링 및 로그.
  - OOV 발생 빈도 모니터링 및 **신조어/이슈 키워드 식별 로그** 생성 (차기 사전 업데이트 반영용).

### 7.3 모듈 C: 예측 및 리포팅 (Predictor)
- **FR-C01:** 달력일(Calendar Day) 기준 시간 감쇠 적용.
- **FR-C02:** 앙상블 점수 산출 (**기본 가중치: Main 0.7, Buffer 0.3**) 및 매수/관망 신호 생성.
- **FR-C03:** OOV 비율 과다 시 예외 처리.
  - OOV 비율이 임계치(예: 30%)를 초과할 경우, 신뢰도 부족으로 판단하여 **'관망(Hold)' 신호**를 생성하고 해당일 거래 대상에서 제외.
- **FR-C04:** 데일리 리포트 생성 (JSON/Markdown).
  - **[개선]** 상위 10개 키워드 정보 제공.
  - **[개선]** 예측 근거 뉴스 목록을 **긍정 뉴스 상위 10건 / 부정 뉴스 상위 10건**으로 분리하여 정렬 및 표시.
- **FR-C05:** 신뢰도 점수 (Confidence Score) 산출 및 표시.
- **FR-C06:** 감성 트렌드 시각화 (최근 5일 Sparkline).
- **FR-C07:** 키워드 클라우드 시각화 (리포트 첨부).
- **FR-C08:** 일반화 성능 검증 (Generalization Verification).
  - 예측일 이후 실제 주가가 확정되면(D+1), 예측 신호(BUY/SELL)와 실제 수익률을 비교하여 검증 리포트 생성.
  - 예: 수요일에 월/화요일 예측 결과 검증.
- **FR-C09:** 대시보드 (Dashboard).
  - Streamlit 기반 웹 대시보드 제공.
  - 일/주/월 단위 예측 결과 및 검증 현황 시각화.
- **FR-C10:** 백테스팅 프레임워크 (Backtesting Framework).
  - **목적:** 서비스 런칭 전 과거 데이터를 통해 시스템의 일반화 성능을 검증하고, 성능 저하 시 개선점을 도출하기 위함.
  - **시나리오 A (Static Split):** 6개월 데이터 수집 -> 초기 4개월 학습(사전 업데이트) -> 이후 2개월 예측 및 검증 -> 검증 리포트 생성.
  - **시나리오 B (Rolling Window):** 1년 데이터 수집 -> 초기 9개월 학습(사전 업데이트) -> 이후 3개월간 [1일 단위 업데이트 -> 예측 -> 검증 -> 리포트] 반복 수행.
  - **결과 활용:** 백테스팅 결과(수익률, 승률 등)가 목표치(KPI)에 미달할 경우, 모델 파라미터(Lasso Alpha, Decay Rate 등) 조정 및 로직 개선의 근거로 활용.

## 8. 품질 기준 및 평가 방법
- **성능 목표 (KPI):**
  - **방향성 정확도:** 매수 신호 시 실제 상승 확률 **55% 이상**.
  - **안정성:** 전체 프로세스 08:30 이전 완료 (장 시작 전).
  - **가동률:** **99% 이상 (데이터 수집 실패 시 Rollback 포함).**
- **테스트 전략:**
  - **Unit Test:** 각 모듈(수집, 전처리, 계산) 단위 테스트.
  - **Backtesting:** 과거 1년 데이터 기반 시뮬레이션 수행.
- **수락 기준:**
  - **데이터 누수 방지:** 학습 데이터(과거)와 추론 데이터(현재)의 엄격한 분리 검증.
  - OOV 비율 30% 미만 유지.
  - 데이터 수집 실패 시 직전 모델 로드(Rollback) 기능 정상 동작.

## 9. 오픈 이슈 및 향후 과제
- **이슈:**
  - 뉴스 저작권 문제에 대한 법적 검토 필요 (현재는 개인 학습/연구용).
  - 장중 실시간 속보 반영 기능 (현재는 일일 배치).
- **향후 과제:**
  - ETF 및 해외 주식으로 대상 확장.
  - LLM(Large Language Model)을 활용한 문맥 분석 도입 검토.

  ## 10. 아키텍처 분해 및 운영 지침 (추가)

  아래 지침은 `.github/copilot-instructions.md`와 `.github/3fs/create-prd.md`의 우선순위를 따릅니다.

  - 목적: 단일 `core` 컨테이너에 모든 기능을 넣는 현재 구조의 리스크(포트/의존성 충돌, 이미지 재현성, 운영 복잡도)를 줄이고, 단계적 마이그레이션을 통해 서비스별 독립 운영을 달성합니다.

  - 권장 서비스 분해:
    - `collector` : 뉴스/주가 수집 (stateless, 스케줄러와 분리)
    - `tokenizer` : MeCab + 사용자사전 로직 (시스템 레벨 의존성 포함)
    - `preprocessor` / `feature-service` : 토큰→특징화 재사용 API
    - `learner` : 배치 학습 작업(Lasso) — 배치 파이프라인
    - `predictor` : 서빙(예측 API), BentoML/Seldon 도입 검토
    - `dashboard` : 웹 UI (권한·포트 분리)
    - `vpn/proxy` : WARP 등 네트워크 도구는 별도 프로세스/사이드카로 분리

  - MeCab 및 사용자사전 운영 가이드:
    - 빌드 시 `mecab-dict-index`로 `user_dic.csv`를 컴파일하여 `.dic` 형태로 이미지에 포함하거나, CI 아티팩트로 관리.
    - 런타임은 `ConfigMap`(작은 파일) 또는 `PVC`/볼륨(빈번 변경)으로 마운트.
    - 핫리로드: initContainer에서 컴파일하거나, 안전한 교체(모델 swap/롤링 재시작) 엔드포인트 제공.
    - 금지: Dockerfile 내에서 private repo를 직접 clone 하지 말 것(빌드 신뢰성 저하).

  - 이미지·빌드 요구사항:
    - MeCab 전용 `base-mecab` 베이스 이미지를 생성하고 사전 및 바이너리를 내장해 재현성 보장.
    - Dockerfile은 멀티스테이지·최소 권한·베이스 이미지 버전 고정 원칙 준수.
    - CI에서 베이스 이미지와 서비스 이미지를 주기적(혹은 PR시)으로 빌드·스캔하며, 이미지 태그와 다이제스트를 기록.

  - 배포·운영 요구사항:
    - 로컬 우선: `docker-compose` 분리(각 서비스 별 compose entry)로 단계적 이전.
    - 장기: Kubernetes 배포 권장(Deployment/StatefulSet, Service, ConfigMap, Secret, PVC).
    - DB는 StatefulSet+PVC; tokenizer는 Deployment로 배포하되 필요시 NodeAffinity로 리소스 고정.
    - readiness/liveness probe 및 Healthcheck 필수.

  - 네트워크·보안 요구사항:
    - VPN/네트워크 에이전트는 애플리케이션 컨테이너 내부에 직접 설치하지 않고 별도 네트워크 컴포넌트(사이드카 또는 전용 pod/호스트)로 분리.
    - 민감한 자격증명은 CI 시크릿/쿠버네티스 Secret으로 관리하고 레포지토리에 저장 금지.

  - 마이그레이션 전략(단계 예시):
    1. `tokenizer`를 별도 컨테이너로 분리하여 내부 API로 전환하고 단위 테스트(특히 사용자사전)를 통과시킴.
    2. `collector` 분리(스케줄→메시지 큐) 및 안정화.
    3. `learner`를 배치 파이프라인으로 분리, `predictor`를 모델 서빙 플랫폼으로 이전.
    4. 최종적으로 k8s로 전환(Helm chart로 배포 자동화).

  - 수용 기준(예시):
    - `tokenizer` 분리 후 동일 입력에 대해 로컬/CI/프로덕션에서 동일 토큰화 결과를 재현(예: '2차전지' 단일 토큰).
    - 이미지 빌드가 외부 인증 실패로 중단되지 않음(모든 원격 아티팩트는 CI에서 사전 수집).
    - 롤아웃/롤백 시 서비스 무중단(또는 허용된 지연) 보장 및 Healthcheck 통과.
