services:
  postgres_db:
    image: postgres:15-alpine
    container_name: n_senti_db
    restart: always
    environment:
      POSTGRES_USER: ${DB_USER:-myuser}
      POSTGRES_PASSWORD: ${DB_PASS:-mypassword}
      POSTGRES_DB: ${DB_NAME:-nsentitrader}
    volumes:
      - n_sentitrader_db_data:/var/lib/postgresql/data
      - ./src/db/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    ports:
      - "5432:5432"

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: n_senti_mq
    restart: always
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${MQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${MQ_PASS:-guest}

  dashboard:
    build: .
    image: n-senti-app
    container_name: n_senti_dashboard
    stop_grace_period: 2s
    command: [ "uv", "run", "uvicorn", "src.dashboard.app:app", "--host", "0.0.0.0", "--port", "8081", "--reload" ]
    restart: always
    ports:
      - "8081:8081"
      - "9095:9095"
    environment:
      - DB_HOST=postgres_db
      - DB_NAME=${DB_NAME:-nsentitrader}
      - DB_USER=${DB_USER:-myuser}
      - DB_PASS=${DB_PASS:-mypassword}
      - MQ_HOST=rabbitmq
      - METRICS_PORT=9095
      - PORT=8081
      - PYTHONUNBUFFERED=1
    volumes:
      - ./src:/app/src
      - ./data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - postgres_db
      - rabbitmq

  address_worker_1:
    build: .
    image: n-senti-app
    container_name: n_senti_address_worker_1
    command: [ "uv", "run", "python", "src/scripts/run_address_worker.py" ]
    restart: always
    environment:
      - DB_HOST=postgres_db
      - DB_NAME=${DB_NAME:-nsentitrader}
      - DB_USER=${DB_USER:-myuser}
      - DB_PASS=${DB_PASS:-mypassword}
      - MQ_HOST=rabbitmq
      - MQ_QUEUE=address_jobs
      - PYTHONUNBUFFERED=1
      - METRICS_PORT=9092
    volumes:
      - ./src:/app/src
      - ./data:/app/data
    depends_on:
      - postgres_db
      - rabbitmq

  address_worker_2:
    build: .
    image: n-senti-app
    container_name: n_senti_address_worker_2
    command: [ "uv", "run", "python", "src/scripts/run_address_worker.py" ]
    restart: always
    environment:
      - DB_HOST=postgres_db
      - DB_NAME=${DB_NAME:-nsentitrader}
      - DB_USER=${DB_USER:-myuser}
      - DB_PASS=${DB_PASS:-mypassword}
      - MQ_HOST=rabbitmq
      - MQ_QUEUE=address_jobs
      - PYTHONUNBUFFERED=1
      - METRICS_PORT=9098
    volumes:
      - ./src:/app/src
      - ./data:/app/data
    depends_on:
      - postgres_db
      - rabbitmq

  daily_address_worker:
    build: .
    image: n-senti-app
    container_name: n_senti_daily_address_worker
    command: [ "uv", "run", "python", "src/scripts/run_address_worker.py" ]
    restart: always
    environment:
      - DB_HOST=postgres_db
      - DB_NAME=${DB_NAME:-nsentitrader}
      - DB_USER=${DB_USER:-myuser}
      - DB_PASS=${DB_PASS:-mypassword}
      - MQ_HOST=rabbitmq
      - MQ_QUEUE=daily_address_jobs
      - PYTHONUNBUFFERED=1
      - METRICS_PORT=9097
    volumes:
      - ./src:/app/src
      - ./data:/app/data
    depends_on:
      - postgres_db
      - rabbitmq

  body_worker:
    build: .
    image: n-senti-app
    command: [ "uv", "run", "python", "src/scripts/run_worker.py" ]
    restart: always
    deploy:
      replicas: 4
    environment:
      - DB_HOST=postgres_db
      - DB_NAME=${DB_NAME:-nsentitrader}
      - DB_USER=${DB_USER:-myuser}
      - DB_PASS=${DB_PASS:-mypassword}
      - MQ_HOST=rabbitmq
      - PYTHONUNBUFFERED=1
      - METRICS_PORT=9093
    volumes:
      - ./src:/app/src
      - ./data:/app/data
    depends_on:
      - postgres_db
      - rabbitmq

  scheduler:
    build: .
    image: n-senti-app
    container_name: n_senti_scheduler
    command: [ "uv", "run", "python", "main_scheduler.py" ]
    restart: always
    depends_on:
      - postgres_db
      - rabbitmq
    environment:
      - DB_HOST=postgres_db
      - DB_NAME=${DB_NAME:-nsentitrader}
      - DB_USER=${DB_USER:-myuser}
      - DB_PASS=${DB_PASS:-mypassword}
      - MQ_HOST=rabbitmq
      - METRICS_PORT=9094
      - PYTHONUNBUFFERED=1
    volumes:
      - ./src:/app/src
      - ./data:/app/data
      - ./main_scheduler.py:/app/main_scheduler.py

  verification_heavy:
    build: .
    image: n-senti-app
    command: [ "uv", "run", "python", "src/scripts/run_verification_worker.py" ]
    restart: always
    deploy:
      replicas: 1
    environment:
      - DB_HOST=postgres_db
      - DB_NAME=${DB_NAME:-nsentitrader}
      - DB_USER=${DB_USER:-myuser}
      - DB_PASS=${DB_PASS:-mypassword}
      - MQ_HOST=rabbitmq
      - MQ_QUEUE=verification_jobs
      - METRICS_PORT=9096
      - PYTHONUNBUFFERED=1
    volumes:
      - ./src:/app/src
      - ./data:/app/data
    depends_on:
      - postgres_db
      - rabbitmq

  verification_light:
    build: .
    image: n-senti-app
    command: [ "uv", "run", "python", "src/scripts/run_verification_worker.py" ]
    restart: always
    deploy:
      replicas: 2
    environment:
      - DB_HOST=postgres_db
      - DB_NAME=${DB_NAME:-nsentitrader}
      - DB_USER=${DB_USER:-myuser}
      - DB_PASS=${DB_PASS:-mypassword}
      - MQ_HOST=rabbitmq
      - MQ_QUEUE=verification_daily
      - METRICS_PORT=9100
      - PYTHONUNBUFFERED=1
    volumes:
      - ./src:/app/src
      - ./data:/app/data
    depends_on:
      - postgres_db
      - rabbitmq

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.2
    container_name: n_senti_cadvisor
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    privileged: true
    depends_on:
      - postgres_db
      - rabbitmq

  prometheus:
    image: prom/prometheus:latest
    container_name: n_senti_prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

  grafana:
    image: grafana/grafana:latest
    container_name: n_senti_grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS=true
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning

volumes:
  n_sentitrader_db_data:
