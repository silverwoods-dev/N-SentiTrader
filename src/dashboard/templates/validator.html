{% extends "base.html" %}

{% block title %}Analytics Hub - N-SentiTrader{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header with Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bento-card bg-gradient-to-br from-indigo-500 to-indigo-700 text-white border-none">
            <p class="text-indigo-100 text-sm">Target Stock</p>
            <div class="flex items-center justify-between">
                <h3 class="text-3xl font-bold">{{ stock_code }}</h3>
                <a href="/analytics/versions/{{ stock_code }}"
                    class="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded transition-colors flex items-center gap-1">
                    <i data-lucide="history" class="w-3 h-3"></i>
                    History
                </a>
            </div>
            <p class="text-xs text-indigo-100 mt-2">
                {% if summary %}{{ summary.start_date }} ~ {{ summary.end_date }}{% else %}-{% endif %}
            </p>
        </div>

        <div class="bento-card">
            <p class="text-gray-500 text-sm">Hit Rate</p>
            <h3 class="text-3xl font-bold text-primary-600">
                {% if summary and summary.total_days > 0 %}
                {{ (summary.correct_days / summary.total_days * 100) | round(2) }}%
                {% else %}
                0%
                {% endif %}
            </h3>
            <p class="text-xs text-gray-400 mt-2">
                {% if summary %}{{ summary.correct_days }} / {{ summary.total_days }} days{% else %}No data{% endif %}
            </p>
        </div>

        <div class="bento-card relative overflow-hidden">
            <p class="text-gray-500 text-sm">Sentiment Polarity</p>
            <div class="h-24 mt-2">
                <canvas id="polarityGauge"></canvas>
            </div>
            <div class="flex justify-between text-[10px] text-gray-400 -mt-2 px-4">
                <span>Negative</span>
                <span>Positive</span>
            </div>
        </div>

        <div class="bento-card relative overflow-hidden group">
            <p class="text-gray-500 text-sm">Status (6-State)</p>
            <div class="flex items-center gap-2 mt-1">
                <span class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider
                    {% if latest_prediction %}
                        {% if latest_prediction.status == 'Strong Buy' %} bg-indigo-100 text-indigo-700
                        {% elif latest_prediction.status == 'Cautious Buy' %} bg-cyan-100 text-cyan-700
                        {% elif latest_prediction.status == 'Strong Sell' %} bg-rose-100 text-rose-700
                        {% elif latest_prediction.status == 'Cautious Sell' %} bg-orange-100 text-orange-700
                        {% elif latest_prediction.status == 'Mixed' %} bg-amber-100 text-amber-700
                        {% else %} bg-gray-100 text-gray-700
                        {% endif %}
                    {% else %} bg-gray-100 text-gray-700
                    {% endif %}">
                    {{ latest_prediction.status if latest_prediction else 'N/A' }}
                </span>
            </div>
            <h3 class="text-2xl font-bold mt-2">
                {% if latest_prediction and latest_prediction.expected_alpha %}
                {{ "+%.2f"|format(latest_prediction.expected_alpha * 100) }}%
                {% else %}0.00%{% endif %}
            </h3>
            <p class="text-[10px] text-gray-400">Expected Alpha</p>
        </div>
    </div>

    <!-- Analytics Navigation -->
    <div class="mb-6">
        <nav class="flex space-x-1 border-b border-gray-200 dark:border-gray-700 overflow-x-auto" role="tablist"
            aria-label="Analytics Views">
            <button id="tab-current" hx-get="/analytics/current?stock_code={{ stock_code }}" hx-target="#view-content"
                hx-swap="innerHTML" hx-indicator="#loading-indicator"
                class="tab-button px-6 py-3 text-sm font-semibold border-b-2 border-indigo-600 text-indigo-600 dark:text-indigo-400 whitespace-nowrap"
                role="tab" aria-selected="true" aria-controls="view-content" onclick="setActiveTab('current')">
                <div class="flex items-center gap-2">
                    <i data-lucide="list" class="w-4 h-4"></i>
                    <span>Current View</span>
                </div>
            </button>
            <button id="tab-timeline" hx-get="/analytics/timeline?stock_code={{ stock_code }}&range=30d"
                hx-target="#view-content" hx-swap="innerHTML" hx-indicator="#loading-indicator"
                class="tab-button px-6 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-200 whitespace-nowrap"
                role="tab" aria-selected="false" aria-controls="view-content" onclick="setActiveTab('timeline')">
                <div class="flex items-center gap-2">
                    <i data-lucide="line-chart" class="w-4 h-4"></i>
                    <span>Timeline View</span>
                </div>
            </button>
            <button id="tab-performance"
                class="tab-button px-6 py-3 text-sm font-semibold border-b-2 border-transparent text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-200 whitespace-nowrap"
                role="tab" aria-selected="false" aria-controls="view-content"
                onclick="setActiveTab('performance'); loadPerformance()">
                <div class="flex items-center gap-2">
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                    <span>Performance</span>
                </div>
            </button>
        </nav>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="htmx-indicator mt-4">
            <div class="flex items-center justify-center gap-2 text-gray-500">
                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <span class="text-sm">Loading...</span>
            </div>
        </div>
    </div>

    <!-- View Container (HTMX) -->
    <div id="view-content" role="tabpanel">
        {% include 'partials/validator_current.html' %}
    </div>
</div>

<!-- Grounding Modal -->
<div id="grounding-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl overflow-hidden shadow-2xl">
        <div class="px-6 py-4 border-b flex justify-between">
            <h3 class="font-bold">Evidence Grounding: <span id="grounding-word"></span></h3>
            <button onclick="closeGrounding()" class="p-2 text-2xl">&times;</button>
        </div>
        <div class="p-6 max-h-[60vh] overflow-y-auto" id="grounding-content"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let perfChart = null;
    let scatterChart = null;
    let polarityChart = null;

    function setActiveTab(tabName) {
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.add('border-transparent', 'text-gray-600', 'dark:text-gray-400');
            btn.classList.remove('border-indigo-600', 'text-indigo-600', 'dark:text-indigo-400');
        });
        const activeTab = document.getElementById('tab-' + tabName);
        if (activeTab) {
            activeTab.classList.remove('border-transparent', 'text-gray-600', 'dark:text-gray-400');
            activeTab.classList.add('border-indigo-600', 'text-indigo-600', 'dark:text-indigo-400');
        }
    }

    function loadPerformance() {
        const fullData = {{ chart_data | tojson
    }};
    window.allChartData = fullData;
    const html = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="lg:col-span-2 bento-card">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-bold">Performance Trend</h2>
                        <div class="flex gap-2">
                            <button id="perf-btn-7" class="text-xs px-3 py-1 bg-gray-100 rounded-lg" onclick="updatePerfRange(7)">7D</button>
                            <button id="perf-btn-30" class="text-xs px-3 py-1 bg-indigo-600 text-white rounded-lg" onclick="updatePerfRange(30)">30D</button>
                            <button id="perf-btn-90" class="text-xs px-3 py-1 bg-gray-100 rounded-lg" onclick="updatePerfRange(90)">90D</button>
                        </div>
                    </div>
                    <div class="h-[400px]"><canvas id="performanceChart"></canvas></div>
                </div>
                <div class="bento-card">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-bold">Alpha Correlation (RÂ²)</h2>
                        <div id="corr-val" class="text-xs font-mono text-indigo-600 bg-indigo-50 px-2 py-1 rounded">R: ...</div>
                    </div>
                    <div class="h-[300px]"><canvas id="scatterChart"></canvas></div>
                </div>
            </div>`;
    document.getElementById('view-content').innerHTML = html;
    lucide.createIcons();
    updatePerfRange(30);
    }

    function renderChart(chartData) {
        const ctx = document.getElementById('performanceChart')?.getContext('2d');
        if (!ctx) return;
        if (perfChart) perfChart.destroy();
        perfChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    { label: 'Expected Alpha', data: chartData.expected_alphas, borderColor: '#6366f1', fill: true, tension: 0.4 },
                    { label: 'Actual Alpha', data: chartData.alphas, borderColor: '#10b981', borderDash: [5, 5], tension: 0 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { unit: 'day' } },
                    y: { ticks: { callback: v => (v * 100).toFixed(1) + '%' } }
                }
            }
        });
    }

    function renderScatter(days) {
        const ctx = document.getElementById('scatterChart')?.getContext('2d');
        if (!ctx) return;
        const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - days);
        const cutoffStr = cutoff.toISOString().split('T')[0];

        const dataPoints = (window.allChartData?.expected_alphas || [])
            .filter(d => d.x >= cutoffStr)
            .map(d => {
                const actual = (window.allChartData?.alphas || []).find(a => a.x === d.x);
                return actual ? { x: d.y, y: actual.y } : null;
            }).filter(p => p !== null);

        if (scatterChart) scatterChart.destroy();
        scatterChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Expected vs Actual',
                    data: dataPoints,
                    backgroundColor: 'rgba(99, 102, 241, 0.5)',
                    pointRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Expected Alpha' }, ticks: { callback: v => (v * 100).toFixed(1) + '%' } },
                    y: { title: { display: true, text: 'Actual Alpha' }, ticks: { callback: v => (v * 100).toFixed(1) + '%' } }
                }
            }
        });

        if (dataPoints.length > 1) {
            const r = calculateCorrelation(dataPoints.map(p => p.x), dataPoints.map(p => p.y));
            document.getElementById('corr-val').innerText = `R: ${r.toFixed(3)}`;
        } else {
            document.getElementById('corr-val').innerText = 'R: N/A';
        }
    }

    function calculateCorrelation(x, y) {
        const n = x.length;
        const sumX = x.reduce((a, b) => a + b, 0);
        const sumY = y.reduce((a, b) => a + b, 0);
        const sumXY = x.reduce((a, b, i) => a + b * y[i], 0);
        const sumX2 = x.reduce((a, b) => a + b * b, 0);
        const sumY2 = y.reduce((a, b) => a + b * b, 0);
        const num = n * sumXY - sumX * sumY;
        const den = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
        return den === 0 ? 0 : num / den;
    }

    function updatePerfRange(days) {
        [7, 30, 90].forEach(d => {
            const btn = document.getElementById('perf-btn-' + d);
            if (btn) btn.className = d === days ? 'text-xs px-3 py-1 bg-indigo-600 text-white rounded-lg' : 'text-xs px-3 py-1 bg-gray-100 rounded-lg';
        });
        const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - days);
        const cutoffStr = cutoff.toISOString().split('T')[0];
        renderChart({
            expected_alphas: (window.allChartData?.expected_alphas || []).filter(d => d.x >= cutoffStr),
            alphas: (window.allChartData?.alphas || []).filter(d => d.x >= cutoffStr)
        });
        renderScatter(days);
    }

    function showGrounding(word, date) {
        document.getElementById('grounding-word').innerText = word;
        document.getElementById('grounding-modal').classList.remove('hidden');
        document.getElementById('grounding-content').innerHTML = 'Loading...';
        fetch(`/analytics/grounding/{{ stock_code }}/${date}/${word}`)
            .then(res => res.json())
            .then(data => {
                if (!data.news || data.news.length === 0) {
                    document.getElementById('grounding-content').innerHTML = 'No news found.';
                    return;
                }
                let h = '<ul class="space-y-4">';
                data.news.forEach(n => h += `<li><a href="${n.url}" target="_blank" class="font-bold text-indigo-600">${n.title}</a><p class="text-xs text-gray-500">${n.published_at}</p></li>`);
                document.getElementById('grounding-content').innerHTML = h + '</ul>';
            });
    }

    function closeGrounding() { document.getElementById('grounding-modal').classList.add('hidden'); }

    function renderPolarityGauge() {
        {% if latest_prediction %}
        const net = {{ latest_prediction.sentiment_score or 0 }};
    const intensity = {{ latest_prediction.intensity or 0.0001 }};
    const pos = (intensity + net) / 2;
    const neg = Math.abs((net - intensity) / 2);
    const ctx = document.getElementById('polarityGauge')?.getContext('2d');
    if (!ctx) return;
    if (polarityChart) polarityChart.destroy();
    polarityChart = new Chart(ctx, {
        type: 'doughnut',
        data: { datasets: [{ data: [neg, pos], backgroundColor: ['#ef4444', '#10b981'] }] },
        options: { circumference: 180, rotation: 270, cutout: '75%', plugins: { legend: { display: false } } }
    });
    {% endif %}
    }

    document.addEventListener('DOMContentLoaded', () => { renderPolarityGauge(); lucide.createIcons(); });
    document.body.addEventListener('htmx:afterSwap', () => { renderPolarityGauge(); lucide.createIcons(); });
</script>
{% endblock %}