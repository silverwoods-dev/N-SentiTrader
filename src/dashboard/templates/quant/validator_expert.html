{% extends "base.html" %}
{% block title %}Expert Analytics - {{ stock_code }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header: KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-8 gap-4">
        <div class="bento-card bg-slate-900 text-white border-none md:col-span-2 lg:col-span-2">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-xl font-black mb-1 line-clamp-1">{{ stock_name }}</h1>
                    <p class="text-[10px] text-gray-400">{{ stock_code }}</p>
                </div>
            </div>
            <div class="mt-3 flex gap-4">
                  <div class="flex-1">
                    <label class="text-[8px] font-bold uppercase text-gray-400 block">Hit Rate (ì ì¤‘ë¥ )</label>
                    <p class="text-lg font-black text-indigo-400">
                        {% if summary.total_days > 0 %}
                        {{ "%.1f"|format(summary.correct_days / summary.total_days * 100) }}%
                        {% else %}0.0%{% endif %}
                    </p>
                  </div>
                  <div class="flex-1">
                    <label class="text-[8px] font-bold uppercase text-gray-400 block">Days (ë¶„ì„ ì¼ìˆ˜)</label>
                    <p class="text-lg font-black">{{ summary.total_days }}</p>
                  </div>
            </div>
            <div class="mt-3">
                <select onchange="changeVersion(this.value)" class="w-full bg-slate-800 text-[10px] text-white border-slate-700 rounded p-1.5 focus:ring-1 focus:ring-indigo-500">
                    <option value="" {% if not v_job_id %}selected{% endif %}>
                        Live Model (ì‹¤ì‹œê°„ ìš´ì˜ ëª¨ë¸: {{ active_model.window if active_model else '?' }}M / Î±={{ "%.4f"|format(active_model.alpha) if active_model else '?' }})
                    </option>
                    {% for v in versions %}
                    <option value="{{ v.v_job_id }}" {% if v_job_id == v.v_job_id %}selected{% endif %}>
                        {{ v.label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- ML Stats -->
        <div class="bento-card">
            <label class="text-[8px] font-bold uppercase text-gray-400 block mb-1">IC (Skill / ì˜ˆì¸¡ ìˆ™ë ¨ë„)</label>
            <p class="text-xl font-black {% if expert_metrics.ic > 0.05 %}text-emerald-500{% elif expert_metrics.ic < -0.05 %}text-red-500{% endif %}">
                {{ "%.3f"|format(expert_metrics.ic) or '0.000' }}
            </p>
            <p class="text-[8px] text-gray-400 mt-1">Information Coeff (ì •ë³´ ê³„ìˆ˜)</p>
        </div>

        <div class="bento-card">
            <label class="text-[8px] font-bold uppercase text-gray-400 block mb-1">RMSE (ì˜ˆì¸¡ ì˜¤ì°¨)</label>
            <p class="text-xl font-black text-orange-500">{{ "%.3f"|format(expert_metrics.rmse) or '0.000' }}</p>
            <p class="text-[8px] text-gray-400 mt-1">Prediction Error (í‰ê·  ì˜¤ì°¨)</p>
        </div>

        <!-- Financial Stats -->
        <div class="bento-card">
            <label class="text-[8px] font-bold uppercase text-gray-400 block mb-1">Sharpe (ìƒ¤í”„ ì§€ìˆ˜)</label>
            <p class="text-xl font-black text-indigo-500">{{ "%.2f"|format(expert_metrics.sharpe) or '0.00' }}</p>
            <p class="text-[8px] text-gray-400 mt-1">Ann. Risk-Adj (ì—°ê°„ ìœ„í˜‘ ëŒ€ë¹„ ìˆ˜ìµ)</p>
        </div>

        <div class="bento-card">
            <label class="text-[8px] font-bold uppercase text-gray-400 block mb-1">Inf. Ratio (ì •ë³´ ë¹„ìœ¨)</label>
            <p class="text-xl font-black text-blue-500">{{ "%.2f"|format(expert_metrics.ir) or '0.00' }}</p>
            <p class="text-[8px] text-gray-400 mt-1">Consistency (ìˆ˜ìµ ì¼ê´€ì„±)</p>
        </div>

        <div class="bento-card">
            <label class="text-[8px] font-bold uppercase text-gray-400 block mb-1">Profit Factor (ìˆ˜ìµ ìš”ì¸)</label>
            <p class="text-xl font-black {% if expert_metrics.profit_factor > 1.2 %}text-emerald-500{% elif expert_metrics.profit_factor < 0.8 %}text-red-500{% endif %}">
                {{ "%.2f"|format(expert_metrics.profit_factor) or '0.00' }}
            </p>
            <p class="text-[8px] text-gray-400 mt-1">W/L Ratio (ì†ìµë¹„)</p>
        </div>

        <div class="bento-card">
            <label class="text-[8px] font-bold uppercase text-gray-400 block mb-1">MDD / Duration (ìµœëŒ€ ë‚™í­)</label>
            <p class="text-xl font-black text-rose-500">{{ "%.1f"|format(expert_metrics.mdd) or '0.0' }}%</p>
            <p class="text-[8px] text-gray-400 mt-1">{{ expert_metrics.mdd_duration }} Days Under Peak (íšŒë³µ ì¼ìˆ˜)</p>
        </div>

        <div class="bento-card">
            <label class="text-[8px] font-bold uppercase text-gray-400 block mb-1">Sortino Ratio (ì†Œë¥´í‹°ë…¸)</label>
            <p class="text-xl font-black text-indigo-500">{{ "%.2f"|format(expert_metrics.sortino) or '0.00' }}</p>
            <p class="text-[8px] text-gray-400 mt-1">Downside Adjusted (í•˜ë°© ë¦¬ìŠ¤í¬ ì¡°ì •)</p>
        </div>

        <div class="bento-card">
            <label class="text-[8px] font-bold uppercase text-gray-400 block mb-1">Volatility (ë³€ë™ì„±)</label>
            <p class="text-xl font-black text-amber-500">{{ "%.1f"|format(expert_metrics.volatility) or '0.0' }}%</p>
            <p class="text-[8px] text-gray-400 mt-1">Annualized StdDev (ì—°ê°„ í‘œì¤€í¸ì°¨)</p>
        </div>

        <div class="bento-card">
            <label class="text-[8px] font-bold uppercase text-gray-400 block mb-1">Beta (ì‹œì¥ ë¯¼ê°ë„)</label>
            <p class="text-xl font-black text-blue-400">{{ "%.2f"|format(expert_metrics.beta) or '1.00' }}</p>
            <p class="text-[8px] text-gray-400 mt-1">vs Sector/Benchmark (ë²¤ì¹˜ë§ˆí¬ ëŒ€ë¹„)</p>
        </div>
    </div>

    <!-- TOP METRICS GLOSSARY (Collapsible) -->
    <details class="bento-card bg-slate-50/50 dark:bg-slate-900/30 border-dashed mb-4">
        <summary class="cursor-pointer text-xs font-bold text-gray-500 flex items-center gap-2">
            <i data-lucide="book-open" class="w-3 h-3"></i> ìƒë‹¨ ì§€í‘œ ìš©ì–´ ì„¤ëª… (Click to expand)
        </summary>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4 text-[10px] leading-relaxed">
            <div><b class="text-emerald-600">Hit Rate (ì ì¤‘ë¥ )</b>: ë°©í–¥ ì˜ˆì¸¡ì´ ë§ì€ ë¹„ìœ¨. 50% ì´ìƒì´ë©´ ë¬´ì‘ìœ„ë³´ë‹¤ ë‚˜ì€ ì˜ˆì¸¡ë ¥ì…ë‹ˆë‹¤.</div>
            <div><b class="text-orange-600">RMSE (ì˜ˆì¸¡ ì˜¤ì°¨)</b>: ì˜ˆì¸¡ê°’ê³¼ ì‹¤ì œê°’ ì°¨ì´ì˜ í‰ê· . ë‚®ì„ìˆ˜ë¡ ì •í™•í•œ ì˜ˆì¸¡ì…ë‹ˆë‹¤.</div>
            <div><b class="text-indigo-600">Sharpe (ìƒ¤í”„ ì§€ìˆ˜)</b>: ìœ„í—˜ ëŒ€ë¹„ ìˆ˜ìµë¥ . 1 ì´ìƒì´ë©´ ì–‘í˜¸, 2 ì´ìƒì´ë©´ ìš°ìˆ˜í•©ë‹ˆë‹¤.</div>
            <div><b class="text-blue-600">Inf. Ratio (ì •ë³´ ë¹„ìœ¨)</b>: ì´ˆê³¼ ìˆ˜ìµì˜ ì¼ê´€ì„±. ë†’ì„ìˆ˜ë¡ ì•ˆì •ì ìœ¼ë¡œ ë²¤ì¹˜ë§ˆí¬ë¥¼ ì´ê¸°ê³  ìˆìŠµë‹ˆë‹¤.</div>
            <div><b class="text-green-600">Profit Factor (ìˆ˜ìµìš”ì¸)</b>: ì´ ì´ìµ Ã· ì´ ì†ì‹¤. 1.5 ì´ìƒì´ë©´ ì–‘í˜¸í•œ ì „ëµì…ë‹ˆë‹¤.</div>
            <div><b class="text-rose-600">MDD (ìµœëŒ€ ë‚™í­)</b>: ê³ ì  ëŒ€ë¹„ ìµœëŒ€ í•˜ë½ë¥ . ì‘ì„ìˆ˜ë¡ ë¦¬ìŠ¤í¬ê°€ ë‚®ì€ ì•ˆì •ì  ì „ëµì…ë‹ˆë‹¤.</div>
            <div><b class="text-indigo-600">Sortino (ì†Œë¥´í‹°ë…¸)</b>: í•˜ë°© ë¦¬ìŠ¤í¬ë§Œ ê³ ë ¤í•œ ìƒ¤í”„ ì§€ìˆ˜. ì†ì‹¤ì— ë¯¼ê°í•œ íˆ¬ììì—ê²Œ ì¤‘ìš”í•©ë‹ˆë‹¤.</div>
            <div><b class="text-amber-600">Volatility (ë³€ë™ì„±)</b>: ìˆ˜ìµë¥ ì˜ ì—°ê°„ í‘œì¤€í¸ì°¨. ë†’ì„ìˆ˜ë¡ ê°€ê²© ë³€ë™ì´ í° ê³ ìœ„í—˜ ìì‚°ì…ë‹ˆë‹¤.</div>
            <div><b class="text-blue-600">Beta (ë² íƒ€)</b>: ì‹œì¥ ëŒ€ë¹„ ë¯¼ê°ë„. 1ë³´ë‹¤ í¬ë©´ ì‹œì¥ë³´ë‹¤ ë” ë§ì´ ì›€ì§ì…ë‹ˆë‹¤.</div>
        </div>
    </details>

    <!-- Navigation Tabs -->
    <div class="flex border-b border-gray-200 dark:border-gray-700">
        <button onclick="switchExpertTab('calibration')" id="tab-btn-calibration" class="px-6 py-3 text-sm font-bold border-b-2 border-indigo-500 text-indigo-600 dark:text-indigo-400 transition-all">
            A. Stability Landscape (ì•ˆì •ì„± íƒìƒ‰)
        </button>
        <button onclick="switchExpertTab('performance')" id="tab-btn-performance" class="px-6 py-3 text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-all">
            B. Performance & Errors (ìˆ˜ìµì„± ë° ì˜¤ì°¨)
        </button>
        <button onclick="switchExpertTab('forensics')" id="tab-btn-forensics" class="px-6 py-3 text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-all">
            C. Explainability (ì˜ë¯¸ì  ì„¤ëª…ë ¥)
        </button>
        <button onclick="switchExpertTab('accounting')" id="tab-btn-accounting" class="px-6 py-3 text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-all">
            D. Financial Context (ì¬ë¬´ ë§¥ë½)
        </button>
        <button onclick="switchExpertTab('candidates')" id="tab-btn-candidates" class="px-6 py-3 text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-all">
            E. Model Candidates (í›„ë³´êµ°)
        </button>
    </div>

    <!-- MODULE A: STABILITY (Heatmap) -->
    <div id="view-calibration" class="space-y-6">
        <div class="bento-card">
            <div id="heatmap-container" class="w-full h-[500px]"></div>
            <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl text-xs text-blue-700 dark:text-blue-300">
                <strong>Stability Plateau (ì•ˆì •ì„± êµ¬ê°„):</strong> ë†’ì€ ì ìˆ˜(ë…¸ë€ìƒ‰)ëŠ” íŒŒë¼ë¯¸í„° ë³€í™”ì—ë„ ì„±ëŠ¥ì´ ì¼ì •í•˜ê²Œ ìœ ì§€ë˜ëŠ” "ì•ˆì „ êµ¬ì—­"ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. (Higher scores indicate "Safe Zones" resilient to parameter jitter)
            </div>
        </div>
        <!-- Tab A Glossary -->
        <details class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/10 rounded-lg border border-yellow-200 dark:border-yellow-800 text-[10px]">
            <summary class="cursor-pointer font-bold text-yellow-700">ğŸ“– ì´ íƒ­ì˜ ìš©ì–´ ì„¤ëª… (Click to expand)</summary>
            <div class="mt-3 space-y-2 text-gray-600">
                <div><b class="text-yellow-600">Stability Landscape (ì•ˆì •ì„± ì§€í˜•)</b>: ë‹¤ì–‘í•œ Window(í•™ìŠµ ê¸°ê°„)ì™€ Alpha(ê·œì œ ê°•ë„) ì¡°í•©ì—ì„œì˜ ëª¨ë¸ ì„±ëŠ¥ì„ 3D íˆíŠ¸ë§µìœ¼ë¡œ ì‹œê°í™”í•œ ê²ƒ. ë…¸ë€ìƒ‰ ì˜ì—­ì´ ë„“ì„ìˆ˜ë¡ íŒŒë¼ë¯¸í„° ë³€í™”ì— ê°•í•œ ì•ˆì •ì ì¸ ëª¨ë¸ì…ë‹ˆë‹¤.</div>
                <div><b class="text-yellow-600">Stability Score (ì•ˆì •ì„± ì ìˆ˜)</b>: ì—¬ëŸ¬ íŒŒë¼ë¯¸í„° ì„¤ì •ì—ì„œë„ ì„±ëŠ¥ì´ ì¼ê´€ë˜ê²Œ ìœ ì§€ë˜ëŠ” ì •ë„. ë†’ì„ìˆ˜ë¡ ê³¼ì í•©(overfitting) ìœ„í—˜ì´ ë‚®ê³  ì‹¤ì „ì—ì„œë„ ì˜ ì‘ë™í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.</div>
            </div>
        </details>
    </div>

    <!-- MODULE B: PERFORMANCE (Equity Curve & Residuals) -->
    <div id="view-performance" class="hidden space-y-6">
        <div class="bento-card h-[400px]">
            <h3 class="text-sm font-bold mb-4">Cumulative Returns: Strategy vs Benchmark (ìˆ˜ìµë¥  ê³¡ì„ )</h3>
            <canvas id="equityChart"></canvas>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bento-card h-[400px]">
                <h3 class="text-sm font-bold mb-4">Residual Scatter: Predicted vs Actual Alpha (ì”ì°¨ ë¶„ì‚°)</h3>
                <canvas id="residualChart"></canvas>
            </div>
            <div class="bento-card h-[400px]">
                <h3 class="text-sm font-bold mb-4">Residual Distribution (Histogram / ì˜¤ì°¨ ë¶„í¬)</h3>
                <canvas id="residualHistChart"></canvas>
            </div>
        </div>
        <!-- Tab B Glossary -->
        <details class="mt-4 p-3 bg-teal-50 dark:bg-teal-900/10 rounded-lg border border-teal-200 dark:border-teal-800 text-[10px]">
            <summary class="cursor-pointer font-bold text-teal-700">ğŸ“– ì´ íƒ­ì˜ ìš©ì–´ ì„¤ëª… (Click to expand)</summary>
            <div class="mt-3 space-y-2 text-gray-600">
                <div><b class="text-teal-600">Equity Curve (ìˆ˜ìµë¥  ê³¡ì„ )</b>: ì‹œê°„ì— ë”°ë¥¸ ëˆ„ì  ìˆ˜ìµë¥  ì¶”ì´. ì „ëµ(Strategy)ê³¼ ë²¤ì¹˜ë§ˆí¬(Benchmark)ë¥¼ ë¹„êµí•˜ì—¬ ìƒëŒ€ì  ì„±ê³¼ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤. ìš°ìƒí–¥í• ìˆ˜ë¡ ì¢‹ì€ ì„±ê³¼ì…ë‹ˆë‹¤.</div>
                <div><b class="text-teal-600">Residual (ì”ì°¨)</b>: ì˜ˆì¸¡ê°’ê³¼ ì‹¤ì œê°’ì˜ ì°¨ì´. ì”ì°¨ê°€ 0ì— ê°€ê¹ê³  ë¬´ì‘ìœ„ë¡œ ë¶„í¬ë˜ì–´ ìˆìœ¼ë©´ ì¢‹ì€ ëª¨ë¸ì…ë‹ˆë‹¤. íŒ¨í„´ì´ ë³´ì´ë©´ ëª¨ë¸ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
                <div><b class="text-teal-600">Benchmark (ë²¤ì¹˜ë§ˆí¬)</b>: ë¹„êµ ê¸°ì¤€ì´ ë˜ëŠ” ì§€ìˆ˜ë‚˜ ì „ëµ. ë³´í†µ ì‹œì¥ í‰ê·  ìˆ˜ìµë¥ (Buy & Hold)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ë³´ë‹¤ ë‚˜ì€ ì„±ê³¼ë¥¼ ë³´ì—¬ì•¼ ì˜ë¯¸ ìˆëŠ” ì „ëµì…ë‹ˆë‹¤.</div>
            </div>
        </details>
    </div>

    <!-- MODULE C: FORENSICS -->
    <div id="view-forensics" class="hidden animate-in fade-in duration-500">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bento-card md:col-span-2">
                <h3 class="text-xs font-black uppercase text-gray-400 mb-4">Sentiment Driver Stability (Feature Beta)</h3>
                <div class="h-[400px]">
                    <canvas id="importanceChart"></canvas>
                </div>
            </div>
            <div class="bento-card">
                <h3 class="text-xs font-black uppercase text-gray-400 mb-4">Forensic Insights (í¬ë Œì‹ ë¶„ì„)</h3>
                <div class="space-y-4">
                    <div class="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                        <label class="text-[8px] font-bold text-gray-400 uppercase">Model Stability (ëª¨ë¸ ì•ˆì •ì„±)</label>
                        <p class="text-[11px] text-gray-600 dark:text-gray-300 mt-1">
                            ì—¬ëŸ¬ ê´€ì¸¡ ê¸°ê°„ ë™ì•ˆ ë†’ì€ ê³„ìˆ˜(Beta)ë¥¼ ìœ ì§€í•˜ëŠ” í‚¤ì›Œë“œëŠ” ëª¨ë¸ì˜ "ì£¼ì œì  ì¼ê´€ì„±(Thematic Continuity)"ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
                        </p>
                    </div>
                    <div class="p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg">
                        <label class="text-[8px] font-bold text-indigo-400 uppercase">Timeline Guide (íƒ€ì„ë¼ì¸ ê°€ì´ë“œ)</label>
                        <p class="text-[11px] text-indigo-600 dark:text-indigo-300 mt-1">
                            ì•„ë˜ íƒ€ì„ë¼ì¸ì€ ë§¤ì¼ì˜ ì˜ˆì¸¡ ê²°ê³¼ì— ê°€ì¥ í° ì˜í–¥ì„ ì¤€ ë©”ì¸ í‚¤ì›Œë“œ(Sentiment Driver)ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Thematic Forensic Timeline -->
        <div class="bento-card mt-6">
            <h3 class="text-xs font-black uppercase text-gray-400 mb-6 flex items-center gap-2">
                <i data-lucide="clock" class="w-4 h-4"></i> Thematic Forensic Timeline (Daily Drivers / ì¼ë³„ ì£¼ìš” ê°ì„± ë™ì¸)
            </h3>
            
            <div class="space-y-8">
                {% for week, items in thematic_timeline | groupby('week_label') %}
                <div class="relative">
                    <!-- Week Label -->
                    <div class="absolute -top-3 left-0 px-2 py-0.5 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-500 rounded text-[9px] font-black uppercase">
                        {{ week }}
                    </div>
                    
                    <div class="flex flex-wrap gap-y-6 pt-4 border-t border-slate-100 dark:border-slate-800">
                        {% for item in items %}
                        <div class="flex items-center">
                            <div class="flex flex-col items-center">
                                <span class="text-[8px] font-bold text-gray-400 mb-2">
                                    {{ item.date[-5:] }} ({{ item.weekday_name }})
                                    <span class="ml-1 px-1 rounded text-[6px] {% if item.model == 'H' %}bg-purple-100 text-purple-600{% else %}bg-blue-100 text-blue-600{% endif %}">{{ item.model }}</span>
                                </span>
                                <div class="w-24 p-2 rounded-lg border text-center transition-all hover:scale-105
                                    {% if item.score > 0.3 %}bg-emerald-50 border-emerald-200 dark:bg-emerald-900/20 dark:border-emerald-800
                                    {% elif item.score < -0.3 %}bg-rose-50 border-rose-200 dark:bg-rose-900/20 dark:border-rose-800
                                    {% else %}bg-slate-50 border-slate-200 dark:bg-slate-800 dark:border-slate-700{% endif %}">
                                    <p class="text-[10px] font-black truncate {% if item.score > 0.3 %}text-emerald-700 dark:text-emerald-400{% elif item.score < -0.3 %}text-rose-700 dark:text-rose-400{% else %}text-gray-500{% endif %}">
                                        {{ item.word }}
                                    </p>
                                    <p class="text-[8px] mt-1 text-gray-400">{% if item.weight|abs > 1 %}{{ item.weight|round(1) }}pt{% else %}{{ (item.weight * 100)|round(1) }}%{% endif %}</p>
                                </div>
                            </div>
                            
                            {% if not loop.last %}
                            <div class="flex items-center pt-6 px-1">
                                <i data-lucide="chevron-right" class="w-3 h-3 text-slate-200 dark:text-slate-700"></i>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <!-- Tab C Glossary -->
        <details class="mt-4 p-3 bg-pink-50 dark:bg-pink-900/10 rounded-lg border border-pink-200 dark:border-pink-800 text-[10px]">
            <summary class="cursor-pointer font-bold text-pink-700">ğŸ“– ì´ íƒ­ì˜ ìš©ì–´ ì„¤ëª… (Click to expand)</summary>
            <div class="mt-3 space-y-2 text-gray-600">
                <div><b class="text-pink-600">Sentiment Driver (ê°ì„± ë™ì¸)</b>: ì˜ˆì¸¡ì— ê°€ì¥ í° ì˜í–¥ì„ ë¯¸ì¹œ í‚¤ì›Œë“œ. ì–‘ìˆ˜(+)ë©´ ê¸ì •ì , ìŒìˆ˜(-)ë©´ ë¶€ì •ì  ì˜í–¥ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ëª¨ë¸ì´ ì–´ë–¤ ë‰´ìŠ¤ì— ë°˜ì‘í•˜ëŠ”ì§€ ì´í•´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                <div><b class="text-pink-600">Feature Beta (í”¼ì²˜ ë² íƒ€)</b>: ê° ë‹¨ì–´(í”¼ì²˜)ê°€ ì˜ˆì¸¡ê°’ì— ë¯¸ì¹˜ëŠ” íšŒê·€ ê³„ìˆ˜. ì ˆëŒ“ê°’ì´ í´ìˆ˜ë¡ í•´ë‹¹ ë‹¨ì–´ì˜ ì˜í–¥ë ¥ì´ í½ë‹ˆë‹¤. ì‹œê°„ì— ë”°ë¥¸ ì•ˆì •ì„±ë„ ì¤‘ìš”í•©ë‹ˆë‹¤.</div>
                <div><b class="text-pink-600">L/H íƒœê·¸</b>: ì˜ˆì¸¡ì˜ ì¶œì²˜ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. L = Lasso ëª¨ë¸(TF-IDF ê¸°ë°˜), H = Hybrid ëª¨ë¸(TF-IDF + BERT ì•™ìƒë¸”).</div>
            </div>
        </details>
    </div>

    <!-- MODULE D: CANDIDATES (Checkpoints) -->
    <div id="view-candidates" class="hidden space-y-6">
        <div class="bento-card">
            <h3 class="text-sm font-bold mb-4">AWO Optimization Checkpoints</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-xs text-left">
                    <thead class="bg-gray-50/50 dark:bg-gray-800/30 text-[10px] uppercase font-bold text-gray-400">
                        <tr>
                            <th class="px-3 py-2">Window (ê´€ì¸¡ì°½)</th>
                            <th class="px-3 py-2">Alpha (í¬ì†Œì„± ê·œì œ)</th>
                            <th class="px-3 py-2">Stability (ì•ˆì •ì„±)</th>
                            <th class="px-3 py-2">Hit Rate (ì ì¤‘ë¥ )</th>
                            <th class="px-3 py-2">MAE (ì˜¤ì°¨)</th>
                            <th class="px-3 py-2">Status (ìƒíƒœ)</th>
                            <th class="px-3 py-2 text-right">Action (ì‘ì—…)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 dark:divide-gray-700/50">
                        {% if checkpoints %}
                            {% for cp in checkpoints %}
                            <tr class="hover:bg-gray-50/50 dark:hover:bg-gray-800/30 transition-colors">
                                <td class="px-3 py-3 font-medium">{{ cp.window_months }}M</td>
                                <td class="px-3 py-3 font-mono">{{ cp.alpha }}</td>
                                <td class="px-3 py-3 text-amber-500 font-bold">{{ "%.3f"|format(cp.stability_score or 0) }}</td>
                                <td class="px-3 py-3">{{ "%.1f"|format((cp.hit_rate or 0) * 100) }}%</td>
                                <td class="px-3 py-3 text-gray-500">{{ "%.4f"|format(cp.mae or 0) }}</td>
                                <td class="px-3 py-3">
                                    {% if cp.status == 'promoted' %}
                                        <span class="px-2 py-0.5 rounded bg-emerald-100 text-emerald-700 border border-emerald-200 text-[10px] font-bold">ACTIVE</span>
                                    {% else %}
                                        <span class="text-gray-400">Candidate</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-3 text-right">
                                    {% if cp.status != 'promoted' %}
                                    <button onclick="promoteCheckpoint({{ cp.id }})" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded text-[10px] font-bold transition-colors shadow-sm">
                                        ì ìš© (Promote)
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" class="px-3 py-8 text-center text-gray-400">No checkpoints found for this analysis job.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Tab E Glossary -->
        <details class="mt-4 p-3 bg-sky-50 dark:bg-sky-900/10 rounded-lg border border-sky-200 dark:border-sky-800 text-[10px]">
            <summary class="cursor-pointer font-bold text-sky-700">ğŸ“– ì´ íƒ­ì˜ ìš©ì–´ ì„¤ëª… (Click to expand)</summary>
            <div class="mt-3 space-y-2 text-gray-600">
                <div><b class="text-sky-600">Window (ê´€ì¸¡ì°½)</b>: ëª¨ë¸ í•™ìŠµì— ì‚¬ìš©í•˜ëŠ” ê³¼ê±° ë°ì´í„° ê¸°ê°„(ì›” ë‹¨ìœ„). ê¸¸ìˆ˜ë¡ ì•ˆì •ì ì´ì§€ë§Œ ìµœê·¼ ì‹œì¥ ë³€í™”ì— ë‘”ê°í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë³´í†µ 3~12ê°œì›”ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>
                <div><b class="text-sky-600">Alpha (í¬ì†Œì„± ê·œì œ)</b>: Lasso ëª¨ë¸ì˜ ê·œì œ ê°•ë„. ë†’ì„ìˆ˜ë¡ ì¤‘ìš”í•œ ë‹¨ì–´ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ëŠ” ì œê±°í•©ë‹ˆë‹¤. ê³¼ì í•© ë°©ì§€ì— íš¨ê³¼ì ì´ì§€ë§Œ ë„ˆë¬´ ë†’ìœ¼ë©´ ì¤‘ìš” ì •ë³´ë„ ì†ì‹¤ë©ë‹ˆë‹¤.</div>
                <div><b class="text-sky-600">MAE (í‰ê·  ì ˆëŒ€ ì˜¤ì°¨)</b>: ì˜ˆì¸¡ ì˜¤ì°¨ì˜ ì ˆëŒ€ê°’ í‰ê· . RMSEë³´ë‹¤ ì´ìƒì¹˜ì— ëœ ë¯¼ê°í•˜ì—¬ ì•ˆì •ì ì¸ ì„±ëŠ¥ í‰ê°€ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‚®ì„ìˆ˜ë¡ ì¢‹ìŠµë‹ˆë‹¤.</div>
                <div><b class="text-sky-600">Checkpoint (ì²´í¬í¬ì¸íŠ¸)</b>: íŠ¹ì • íŒŒë¼ë¯¸í„° ì¡°í•©ìœ¼ë¡œ ì €ì¥ëœ ëª¨ë¸ í›„ë³´. ì„±ëŠ¥ì´ ì¢‹ì€ ì²´í¬í¬ì¸íŠ¸ë¥¼ Promoteí•˜ë©´ ì‹¤ì œ ì„œë¹„ìŠ¤ì— ì ìš©ë©ë‹ˆë‹¤.</div>
            </div>
        </details>
    </div>
    <!-- MODULE D: ACCOUNTING CONTEXT -->
    <div id="view-accounting" class="hidden animate-in fade-in duration-500">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bento-card">
                <h3 class="text-xs font-black uppercase text-gray-400 mb-4">Latest Fundamentals (ìµœì‹  ì¬ë¬´ ì§€í‘œ)</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                        <span class="text-xs font-bold text-gray-500">PER</span>
                        <span class="text-lg font-black text-indigo-500">{{ fundamentals.per or 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                        <span class="text-xs font-bold text-gray-500">PBR</span>
                        <span class="text-lg font-black text-emerald-500">{{ fundamentals.pbr or 'N/A' }}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                        <span class="text-xs font-bold text-gray-500">ROE</span>
                        <span class="text-lg font-black text-amber-500">{{ fundamentals.roe or 'N/A' }}%</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg">
                        <span class="text-xs font-bold text-gray-500">Market Cap (ì‹œê°€ì´ì•¡)</span>
                        <span class="text-lg font-black text-slate-700 dark:text-slate-200">
                            {% if fundamentals.market_cap %}
                                {{ "{:,.0f}".format(fundamentals.market_cap / 100000000) }} ì–µ
                            {% else %}N/A{% endif %}
                        </span>
                    </div>
                </div>

                <div class="mt-8 p-6 bg-indigo-50/30 dark:bg-indigo-900/10 rounded-2xl text-center border border-indigo-100/50 dark:border-indigo-800/30">
                    <i data-lucide="info" class="w-8 h-8 text-indigo-400 mx-auto mb-3"></i>
                    <h4 class="text-xs font-black text-indigo-600 dark:text-indigo-400 mb-2">Safety Margin Evaluation</h4>
                    <p class="text-[10px] text-gray-500 leading-relaxed">
                        ê°ì„± ë¶„ì„ ì‹ í˜¸ëŠ” ì¬ë¬´ ì§€í‘œê°€ ì—­ì‚¬ì  ì €í‰ê°€ êµ¬ê°„ì— ìˆì„ ë•Œ ë” ê°•ë ¥í•œ ìƒë°© ì§€ì§€ë ¥ì„ ê°€ì§‘ë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <div class="bento-card lg:col-span-2">
                <h3 class="text-xs font-black uppercase text-gray-400 mb-4">Fundamental Trends (ì¬ë¬´ ì§€í‘œ ì¶”ì´)</h3>
                <div class="h-[400px] relative">
                    {% if fundamental_history %}
                        <canvas id="fundamentalTrendChart"></canvas>
                    {% else %}
                        <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-xs">
                            <i data-lucide="bar-chart-2" class="w-8 h-8 mb-2 opacity-20 block mx-auto"></i>
                            ì¶”ì´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (No historical data available)
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Tab D Glossary -->
        <details class="mt-4 p-3 bg-purple-50 dark:bg-purple-900/10 rounded-lg border border-purple-200 dark:border-purple-800 text-[10px]">
            <summary class="cursor-pointer font-bold text-purple-700">ğŸ“– ì´ íƒ­ì˜ ìš©ì–´ ì„¤ëª… (Click to expand)</summary>
            <div class="mt-3 space-y-2 text-gray-600">
                <div><b class="text-purple-600">PER (ì£¼ê°€ìˆ˜ìµë¹„ìœ¨)</b>: ì£¼ê°€ë¥¼ ì£¼ë‹¹ìˆœì´ìµ(EPS)ìœ¼ë¡œ ë‚˜ëˆˆ ê°’. ì—…ì¢… í‰ê·  ëŒ€ë¹„ ë‚®ìœ¼ë©´ ì €í‰ê°€ë¡œ í•´ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë†’ë‹¤ë©´ ì‹œì¥ì´ ë¯¸ë˜ ì„±ì¥ì„ ê¸°ëŒ€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.</div>
                <div><b class="text-purple-600">PBR (ì£¼ê°€ìˆœìì‚°ë¹„ìœ¨)</b>: ì£¼ê°€ë¥¼ ì£¼ë‹¹ìˆœìì‚°(BPS)ìœ¼ë¡œ ë‚˜ëˆˆ ê°’. 1 ë¯¸ë§Œì´ë©´ ê¸°ì—…ì˜ ì²­ì‚°ê°€ì¹˜ë³´ë‹¤ ì‹¸ê²Œ ê±°ë˜ë˜ê³  ìˆë‹¤ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.</div>
                <div><b class="text-purple-600">ROE (ìê¸°ìë³¸ì´ìµë¥ )</b>: ìê¸°ìë³¸ ëŒ€ë¹„ ìˆœì´ìµ ë¹„ìœ¨(%). ë†’ì„ìˆ˜ë¡ ì£¼ì£¼ ìë³¸ì„ íš¨ìœ¨ì ìœ¼ë¡œ í™œìš©í•˜ì—¬ ì´ìµì„ ë‚´ê³  ìˆìŠµë‹ˆë‹¤. ë³´í†µ 10% ì´ìƒì´ë©´ ì–‘í˜¸í•©ë‹ˆë‹¤.</div>
                <div><b class="text-purple-600">Market Cap (ì‹œê°€ì´ì•¡)</b>: ë°œí–‰ ì£¼ì‹ ìˆ˜ Ã— í˜„ì¬ ì£¼ê°€. ê¸°ì—…ì˜ ì‹œì¥ ê°€ì¹˜ë¥¼ ë‚˜íƒ€ë‚´ë©° ëŒ€í˜•ì£¼/ì¤‘í˜•ì£¼/ì†Œí˜•ì£¼ ë¶„ë¥˜ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</div>
            </div>
        </details>
    </div>

</div>

<!-- Promote Confirmation Modal -->
<div id="promote-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
    <div class="bg-white dark:bg-gray-900 w-full max-w-md mx-4 rounded-3xl shadow-2xl transform scale-95 transition-transform duration-300 border border-gray-100 dark:border-gray-800" id="promote-modal-content">
        <!-- Modal Header -->
        <div class="px-6 py-5 border-b border-gray-100 dark:border-gray-800 flex items-center gap-4">
            <div class="w-12 h-12 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center">
                <i data-lucide="check-circle" class="w-6 h-6 text-indigo-600 dark:text-indigo-400"></i>
            </div>
            <div>
                <h3 class="text-lg font-black text-gray-900 dark:text-gray-100">ëª¨ë¸ ì ìš© í™•ì¸</h3>
                <p class="text-sm text-gray-500">Confirm Model Promotion</p>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed mb-4">
                ì´ ëª¨ë¸ ì„¤ì •ì„ <strong class="text-indigo-600">ì‹¤ì‹œê°„ ìš´ì˜ ëª¨ë¸</strong>ë¡œ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
                <span class="text-gray-400 text-xs">Are you sure you want to promote this model to ACTIVE status?</span>
            </p>
            <div id="promote-model-info" class="p-3 bg-gray-50 dark:bg-gray-800 rounded-xl text-xs text-gray-500 mb-4">
                <!-- Model info will be injected here -->
            </div>
            <div class="p-3 bg-amber-50 dark:bg-amber-900/20 rounded-xl border border-amber-200 dark:border-amber-800/50 text-xs text-amber-700 dark:text-amber-400">
                <strong>âš ï¸ ì£¼ì˜:</strong> ì ìš© í›„ ê¸°ì¡´ ìš´ì˜ ëª¨ë¸ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="px-6 py-4 border-t border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-800/20 rounded-b-3xl flex gap-3 justify-end">
            <button onclick="closePromoteModal()" class="px-4 py-2 rounded-xl text-sm font-bold text-gray-500 hover:text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition-all">
                ì·¨ì†Œ (Cancel)
            </button>
            <button onclick="confirmPromote()" class="px-5 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold transition-all shadow-lg shadow-indigo-500/20">
                ì ìš© (Promote)
            </button>
        </div>
    </div>
</div>

<!-- PLOTLY & CHART.JS -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
    const v_job_id = {{ v_job_id if v_job_id else 'null' }};
    // DATA INJECTION
    const landscapeData = {{ landscape | tojson }};
    const equityData = {{ equity_curve | tojson }};
    const expertMetrics = {{ expert_metrics | tojson }};
    const featureImportance = {{ feature_importance | tojson }};
    const activeModel = {{ active_model | tojson if active_model else 'null' }};
    const thematicTimeline = {{ thematic_timeline | tojson }};
    const fundamentalHistory = {{ fundamental_history | tojson }};

    function switchExpertTab(tabName) {
        ['calibration', 'performance', 'forensics', 'accounting', 'candidates'].forEach(t => {
            const view = document.getElementById(`view-${t}`);
            const btn = document.getElementById(`tab-btn-${t}`);
            if(view) view.classList.add('hidden');
            if(btn) {
                btn.classList.remove('border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400');
                btn.classList.add('border-transparent', 'text-gray-500');
            }
        });

        document.getElementById(`view-${tabName}`).classList.remove('hidden');
        const activeBtn = document.getElementById(`tab-btn-${tabName}`);
        activeBtn.classList.remove('border-transparent', 'text-gray-500');
        activeBtn.classList.add('border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400');
        
        if (tabName === 'calibration') renderHeatmap();
        if (tabName === 'performance') {
            renderEquityChart();
            renderResidualChart();
            renderResidualHistChart();
        }
        if (tabName === 'forensics') {
            renderImportanceChart();
        }
        if (tabName === 'accounting') {
            renderFundamentalChart();
        }
    }

    // Modal-based promote confirmation
    let pendingPromoteId = null;
    
    function promoteCheckpoint(cpId) {
        pendingPromoteId = cpId;
        
        // Show modal
        const modal = document.getElementById('promote-modal');
        const modalContent = document.getElementById('promote-modal-content');
        const modelInfo = document.getElementById('promote-model-info');
        
        // Find checkpoint info from table
        const row = document.querySelector(`button[onclick="promoteCheckpoint(${cpId})"]`)?.closest('tr');
        if (row) {
            const cells = row.querySelectorAll('td');
            modelInfo.innerHTML = `
                <div class="flex gap-4">
                    <div><strong>Window:</strong> ${cells[0]?.textContent || 'N/A'}</div>
                    <div><strong>Alpha:</strong> ${cells[1]?.textContent || 'N/A'}</div>
                    <div><strong>Stability:</strong> ${cells[2]?.textContent || 'N/A'}</div>
                </div>
            `;
        }
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }, 10);
        lucide.createIcons();
    }
    
    function closePromoteModal() {
        const modal = document.getElementById('promote-modal');
        const modalContent = document.getElementById('promote-modal-content');
        
        modal.classList.add('opacity-0');
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
        
        setTimeout(() => {
            modal.classList.add('hidden');
            pendingPromoteId = null;
        }, 300);
    }
    
    async function confirmPromote() {
        if (!pendingPromoteId) return;
        
        const cpId = pendingPromoteId;
        closePromoteModal();
        
        try {
            const resp = await fetch(`/analytics/checkpoints/promote/${cpId}`, { method: 'POST' });
            const data = await resp.json();
            
            if(resp.ok) {
                // Show success toast instead of alert
                showToast('ëª¨ë¸ì´ ì„±ê³µì ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤! (Model promoted successfully)', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showToast('ëª¨ë¸ ì ìš© ì˜¤ë¥˜: ' + (data.error || data.detail || 'Unknown error'), 'error');
            }
        } catch(e) {
            console.error(e);
            showToast('ë°ì´í„° í†µì‹  ì˜¤ë¥˜ (Network error)', 'error');
        }
    }
    
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-6 right-6 z-50 px-6 py-4 rounded-2xl shadow-2xl text-sm font-bold transition-all transform translate-y-4 opacity-0 ${
            type === 'success' ? 'bg-emerald-600 text-white' : 
            type === 'error' ? 'bg-rose-600 text-white' : 
            'bg-gray-800 text-white'
        }`;
        toast.innerHTML = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.remove('translate-y-4', 'opacity-0');
        }, 10);
        
        setTimeout(() => {
            toast.classList.add('translate-y-4', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    // Close modal on backdrop click
    document.getElementById('promote-modal')?.addEventListener('click', function(e) {
        if (e.target === this) closePromoteModal();
    });

    function renderHeatmap() {
        if (!landscapeData || landscapeData.length === 0) return;
        const windows = [...new Set(landscapeData.map(d => d.window))].sort((a,b)=>a-b);
        const alphas = [...new Set(landscapeData.map(d => d.alpha))].sort((a,b)=>a-b);
        const zValues = [];
        for (let a of alphas) {
            const row = [];
            for (let w of windows) {
                const item = landscapeData.find(d => d.window === w && d.alpha === a);
                row.push(item ? item.stability_score : null);
            }
            zValues.push(row);
        }
        const data = [{
            z: zValues, x: windows.map(w => w + "M"), y: alphas.map(a => a.toExponential()),
            type: 'heatmap', colorscale: 'Viridis', hoverongaps: false
        }];

        // Add Active Model Marker
        const layout = {
            title: 'Stability Landscape (ëª¨ë¸ ì•ˆì •ì„± ì§€ë„)',
            xaxis: { title: 'Window Size (ê´€ì¸¡ì°½ í¬ê¸°)' }, yaxis: { title: 'Regularization (ê·œì œ ì •ë„: Alpha)' },
            margin: { t: 50, r: 50, b: 50, l: 80 },
            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Inter, sans-serif', size: 10 },
            annotations: []
        };

        if (activeModel && !v_job_id) {
            layout.annotations.push({
                x: activeModel.window + "M",
                y: activeModel.alpha.toExponential(),
                text: 'â˜… ACTIVE (í˜„ì¬ ìš´ì˜ ëª¨ë¸)',
                showarrow: true,
                arrowhead: 2,
                ax: 0, ay: -30,
                font: { color: '#ffffff', size: 12, weight: '900' },
                bgcolor: '#4f46e5',
                bordercolor: '#4f46e5',
                borderwidth: 1,
                borderpad: 4
            });
        }

        Plotly.newPlot('heatmap-container', data, layout, {responsive: true});
    }

    let equityChartObj = null;
    function renderEquityChart() {
        const ctx = document.getElementById('equityChart')?.getContext('2d');
        if (!ctx || equityChartObj) return;
        equityChartObj = new Chart(ctx, {
            type: 'line',
            data: {
                labels: equityData.dates,
                datasets: [
                    { label: 'Strategy (ì „ëµ ìˆ˜ìµë¥ )', data: equityData.strategy, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', borderWidth: 2, tension: 0, pointRadius: 0 },
                    { label: 'Benchmark (ë²¤ì¹˜ë§ˆí¬)', data: equityData.benchmark, borderColor: '#94a3b8', borderDash: [5, 5], borderWidth: 2, tension: 0, pointRadius: 0 }
                ]
            },
           options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { maxTicksLimit: 10 } } } }
        });
    }

    let residualChartObj = null;
    function renderResidualChart() {
        const ctx = document.getElementById('residualChart')?.getContext('2d');
        if (!ctx || residualChartObj) return;
        const resData = expertMetrics.residual_data;
        residualChartObj = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Residuals (ì”ì°¨ ë¶„í¬)', data: resData,
                    backgroundColor: 'rgba(99, 102, 241, 0.5)', borderColor: '#6366f1', pointRadius: 3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Predicted Alpha (ì˜ˆì¸¡ ìˆ˜ìµë¥ )' } },
                    y: { title: { display: true, text: 'Actual Alpha (ì‹¤ì œ ìˆ˜ìµë¥ )' } }
                }
            }
        });
    }

    let residualHistChartObj = null;
    function renderResidualHistChart() {
        const ctx = document.getElementById('residualHistChart')?.getContext('2d');
        if (!ctx || residualHistChartObj) return;
        const hist = expertMetrics.residual_hist;
        residualHistChartObj = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: hist.bins,
                datasets: [{
                    label: 'Frequency (ë¹ˆë„)', data: hist.counts,
                    backgroundColor: 'rgba(99, 102, 241, 0.2)', borderColor: '#6366f1', borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    let importanceChartObj = null;
    function renderImportanceChart() {
        const ctx = document.getElementById('importanceChart')?.getContext('2d');
        if (!ctx || importanceChartObj) return;
        const labels = featureImportance.map(f => f.word);
        const values = featureImportance.map(f => f.beta);
        importanceChartObj = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Beta Coefficient (íšŒê·€ ê³„ìˆ˜)', data: values,
                    backgroundColor: values.map(v => v > 0 ? 'rgba(52, 211, 153, 0.6)' : 'rgba(248, 113, 113, 0.6)'),
                    borderColor: values.map(v => v > 0 ? '#10b981' : '#ef4444'),
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    let fundamentalChartObj = null;
    function renderFundamentalChart() {
        const canvas = document.getElementById('fundamentalTrendChart');
        if (!canvas || !fundamentalHistory || fundamentalHistory.length === 0) return;
        
        const ctx = canvas.getContext('2d');
        if (fundamentalChartObj) fundamentalChartObj.destroy();
        
        const dates = fundamentalHistory.map(h => h.date);
        const perData = fundamentalHistory.map(h => h.per);
        const pbrData = fundamentalHistory.map(h => h.pbr);

        fundamentalChartObj = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'PER',
                        data: perData,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        pointRadius: 2,
                        yAxisID: 'y'
                    },
                    {
                        label: 'PBR',
                        data: pbrData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        pointRadius: 2,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'top', labels: { boxWidth: 10, font: { size: 10 } } }
                },
                scales: {
                    x: { ticks: { maxTicksLimit: 12, font: { size: 9 } } },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'PER', font: { size: 10, weight: 'bold' } }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: 'PBR', font: { size: 10, weight: 'bold' } }
                    }
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        renderHeatmap(); 
    });

    function changeVersion(jobId) {
        const url = new URL(window.location.href);
        if (jobId) url.searchParams.set('v_job_id', jobId);
        else url.searchParams.delete('v_job_id');
        window.location.href = url.toString();
    }
</script>
{% endblock %}
