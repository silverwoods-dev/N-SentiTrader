{% extends "base.html" %}

{% block title %}Backtest Manager - Quant Hub{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Backtest & Operation Manager</h1>
            <p class="text-gray-500 text-sm">Manage HPO Scans and Daily Lightweight Updates</p>
        </div>
        <button onclick="document.getElementById('new-backtest-modal').showModal()"
            class="btn-primary flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-4 h-4"></i>
            New Job
        </button>
    </div>

    <!-- [NEW] Golden Parameters Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for p in golden_params %}
        <div class="bento-card bg-gradient-to-br from-indigo-50/50 to-white dark:from-indigo-900/10 dark:to-gray-900 border-indigo-100 dark:border-indigo-900/30">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-bold text-indigo-500 uppercase">{{ p.stock_name }}</span>
                <i data-lucide="zap" class="w-4 h-4 text-amber-500"></i>
            </div>
            <div class="space-y-1">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">Window / Alpha</span>
                    <span class="font-mono font-bold">{{ p.window }}m / {{ p.alpha }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500">Optimal Lag</span>
                    <span class="font-mono font-bold">L{{ p.lag }}</span>
                </div>
            </div>
            <div class="mt-3 pt-2 border-t border-gray-100 dark:border-gray-800 flex justify-between items-center text-[10px] text-gray-400">
                <span>Updated: {{ p.updated_at.strftime('%m-%d %H:%M') }}</span>
                <form action="/analytics/backtest/run-daily" method="POST">
                    <input type="hidden" name="stock_code" value="{{ p.stock_code }}">
                    <button type="submit" class="text-indigo-500 hover:text-indigo-600 font-bold">Run Update</button>
                </form>
            </div>
        </div>
        {% endfor %}
        {% if not golden_params %}
        <div class="lg:col-span-4 bento-card border-dashed border-gray-300 dark:border-gray-700 flex flex-col items-center justify-center py-6">
            <i data-lucide="info" class="w-8 h-8 text-gray-300 mb-2"></i>
            <p class="text-gray-400 text-sm italic">No Golden Parameters established. Run AWO Scan 2D first.</p>
        </div>
        {% endif %}
    </div>

    <!-- Jobs Table with Tabs -->
    <div class="bento-card" x-data="{ activeTab: 'all' }">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold flex items-center gap-2">
                <i data-lucide="activity" class="w-5 h-5 text-indigo-500"></i>
                Job History
            </h2>
            <div class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-lg">
                <button @click="activeTab = 'all'" :class="activeTab === 'all' ? 'bg-white dark:bg-gray-700 shadow-sm' : ''"
                    class="px-3 py-1 text-xs rounded-md font-medium transition-all">All</button>
                <button @click="activeTab = 'AWO'" :class="activeTab === 'AWO' ? 'bg-white dark:bg-gray-700 shadow-sm' : ''"
                    class="px-3 py-1 text-xs rounded-md font-medium transition-all">Optimization</button>
                <button @click="activeTab = 'DAILY'" :class="activeTab === 'DAILY' ? 'bg-white dark:bg-gray-700 shadow-sm' : ''"
                    class="px-3 py-1 text-xs rounded-md font-medium transition-all">Operational</button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type / ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Started</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-900">
                    {% for job in jobs %}
                    <tr x-show="activeTab === 'all' || 
                               (activeTab === 'AWO' && '{{ job.v_type }}'.includes('AWO')) || 
                               (activeTab === 'DAILY' && '{{ job.v_type }}' === 'DAILY_UPDATE')"
                        id="job-row-{{ job.v_job_id }}"
                        {% if job.status == 'running' %} hx-get="/analytics/backtest/row/{{ job.v_job_id }}" hx-trigger="every 3s" hx-swap="outerHTML" {% endif %}>
                        {% include "quant/partials/backtest_row.html" %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- New Backtest Modal -->
<dialog id="new-backtest-modal"
    class="modal-box p-0 rounded-2xl bg-white dark:bg-gray-800 text-gray-900 dark:text-white border border-gray-200 dark:border-gray-700 w-full max-w-lg">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h3 class="font-bold text-lg">Create Verification Job</h3>
        <button onclick="document.getElementById('new-backtest-modal').close()"
            class="text-gray-500 hover:text-gray-700">&times;</button>
    </div>
    <form action="/analytics/backtest/create" method="POST" class="p-6 space-y-4">
        <div>
            <label class="block text-sm font-medium mb-1">Target Stock</label>
            <input type="text" name="stock_code" list="available_stocks" placeholder="Search or Enter Code..." 
                class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600 uppercase" required>
            <datalist id="available_stocks">
                {% for c in candidates %}
                <option value="{{ c.stock_code }}">{{ c.stock_name }} (News: {{ c.news_count }})</option>
                {% endfor %}
            </datalist>
            <p class="text-[10px] text-gray-400 mt-1">Select from candidates with sufficient data</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium mb-1">Validation Period (Months)</label>
                <input type="number" name="val_months" value="1" min="1" max="12"
                    class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                <p class="text-[10px] text-gray-400 mt-1">
                    <span class="text-indigo-400 font-bold">Recommended: 1-6 months</span> (Optimized for recent regimes)<br>
                    Max: 12 months (For long-term stability checks)
                </p>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Method</label>
                <select name="v_type" class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                    <option value="AWO_SCAN_2D" selected>AWO 2D Stability Scan (권장)</option>
                    <option value="DAILY_UPDATE">Lightweight Daily Update (운영)</option>
                    <option value="WF_CHECK">Standard Walk-Forward (검증)</option>
                </select>
            </div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-900/50 p-3 rounded-lg border border-gray-100 dark:border-gray-800">
            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Method Description</h4>
            <p id="method-desc" class="text-xs text-gray-400 leading-relaxed">
                <!-- Dynamic Content -->
            </p>
        </div>
        
        <script>
            const descriptions = {
                'AWO_SCAN_2D': `<strong>AWO 2D Stability Scan (권장):</strong><br>
                               윈도우 크기(1~12개월)와 Alpha를 동시에 탐색하여 가장 안정적인 모델을 찾고 'Golden Params'를 갱신합니다.`,
                'DAILY_UPDATE': `<strong>Lightweight Daily Update (운영):</strong><br>
                                백테스팅을 통해 이미 찾은 'Golden Params'를 사용하여 최신 단어 사전 가중치만 빠르게 재학습합니다 (수 초 내 완료).`,
                'WF_CHECK': `<strong>Standard Walk-Forward (검증):</strong><br>
                            설정된 윈도우 크기로 단순 전진 검증을 수행하여 특정 기간의 성과를 측정합니다.`
            };
            
            const selectEl = document.querySelector('select[name="v_type"]');
            const descEl = document.getElementById('method-desc');
            
            function updateDesc() {
                descEl.innerHTML = descriptions[selectEl.value] || "";
            }
            
            selectEl.addEventListener('change', updateDesc);
            updateDesc(); // Init
        </script>

        <div class="flex justify-end pt-4">
            <button type="submit" class="btn-primary w-full py-3">Submit Job</button>
        </div>
    </form>
</dialog>
{% endblock %}