{% extends "base.html" %}

{% block title %}Backtest Manager - Quant Hub{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Backtest & Operation Manager <br> <span class="text-lg font-medium">백테스트 및 운영 관리</span></h1>
            <p class="text-gray-500 text-sm">Manage HPO Scans and Daily Lightweight Updates <br> HPO 스캔 및 일일 경량 업데이트 관리</p>
        </div>
        <button onclick="document.getElementById('new-backtest-modal').showModal()"
            class="btn-primary flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-4 h-4"></i>
            New Job <br> 새 작업
        </button>
    </div>

    <!-- [NEW] Golden Parameters Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for p in golden_params %}
        <div class="bento-card bg-gradient-to-br from-indigo-50/50 to-white dark:from-indigo-900/10 dark:to-gray-900 border-indigo-100 dark:border-indigo-900/30">
            <div class="flex items-center justify-between mb-2">
                <span class="text-xs font-bold text-indigo-500 uppercase">{{ p.stock_name }}</span>
                <i data-lucide="zap" class="w-4 h-4 text-amber-500"></i>
            </div>
            <div class="space-y-1">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500 text-[10px]">Window / Alpha <br> 윈도우 / 알파</span>
                    <span class="font-mono font-bold">{{ p.window }}m / {{ p.alpha }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500 text-[10px]">Optimal Lag <br> 최적 러그(Lag)</span>
                    <span class="font-mono font-bold">L{{ p.lag }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500 text-[10px]">Model <br> 모델</span>
                    <span class="px-1.5 py-0.5 rounded bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 font-bold text-[9px] uppercase">
                        {{ p.model_type or 'tfidf' }}
                    </span>
                </div>
            </div>
            <div class="mt-3 pt-2 border-t border-gray-100 dark:border-gray-800 flex justify-between items-center text-[10px] text-gray-400">
                <span>Updated <br> 업데이트: {{ p.updated_at | kst('%m-%d %H:%M') }}</span>
                <form action="/analytics/backtest/run-daily" method="POST">
                    <input type="hidden" name="stock_code" value="{{ p.stock_code }}">
                    <button type="submit" class="text-indigo-500 hover:text-indigo-600 font-bold">Run Update <br> 업데이트 실행</button>
                </form>
            </div>
        </div>
        {% endfor %}
        {% if not golden_params %}
        <div class="lg:col-span-4 bento-card border-dashed border-gray-300 dark:border-gray-700 flex flex-col items-center justify-center py-6">
            <i data-lucide="info" class="w-8 h-8 text-gray-300 mb-2"></i>
            <p class="text-gray-400 text-sm italic">No Golden Parameters established. Run AWO Scan 2D first.</p>
        </div>
        {% endif %}
    </div>

    <!-- Jobs Table with Tabs -->
    <div class="bento-card" x-data="{ activeTab: 'all' }">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-bold flex items-center gap-2">
                <i data-lucide="activity" class="w-5 h-5 text-indigo-500"></i>
                Job History <br> <span class="text-sm font-medium">작업 내역</span>
            </h2>
            <div class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-lg">
                <button @click="activeTab = 'all'" :class="activeTab === 'all' ? 'bg-white dark:bg-gray-700 shadow-sm' : ''"
                    class="px-3 py-1 text-[10px] rounded-md font-medium transition-all text-center">All <br> 전체</button>
                <button @click="activeTab = 'AWO'" :class="activeTab === 'AWO' ? 'bg-white dark:bg-gray-700 shadow-sm' : ''"
                    class="px-3 py-1 text-[10px] rounded-md font-medium transition-all text-center">Optimization <br> 최적화</button>
                <button @click="activeTab = 'DAILY'" :class="activeTab === 'DAILY' ? 'bg-white dark:bg-gray-700 shadow-sm' : ''"
                    class="px-3 py-1 text-[10px] rounded-md font-medium transition-all text-center">Operational <br> 운영</button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type / ID <br> 유형 / ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock <br> 종목</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status <br> 상태</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress <br> 진행률</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Started <br> 시작 시간</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions <br> 작업</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-900">
                    {% for job in jobs %}
                        {% include "quant/partials/backtest_row.html" %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- New Backtest Modal -->
<dialog id="new-backtest-modal"
    class="modal-box p-0 rounded-2xl bg-white dark:bg-gray-800 text-gray-900 dark:text-white border border-gray-200 dark:border-gray-700 w-full max-w-lg">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h3 class="font-bold text-lg text-center leading-tight">Create Verification Job <br> <span class="text-sm font-medium">검증 작업 생성</span></h3>
        <button onclick="document.getElementById('new-backtest-modal').close()"
            class="text-gray-500 hover:text-gray-700">&times;</button>
    </div>
    <form action="/analytics/backtest/create" method="POST" class="p-6 space-y-4">
        <div>
            <label class="block text-sm font-medium mb-1">Target Stock <br> <span class="text-xs text-gray-500">대상 종목</span></label>
            <input type="text" name="stock_code" list="available_stocks" placeholder="Search or Enter Code... 종목 검색 또는 코드 입력..." 
                class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600 uppercase" required>
            <datalist id="available_stocks">
                {% for c in candidates %}
                <option value="{{ c.stock_code }}">{{ c.stock_name }} (News: {{ c.news_count }})</option>
                {% endfor %}
            </datalist>
            <p class="text-[10px] text-gray-400 mt-1">Select from candidates with sufficient data <br> 데이터가 충분한 대상 종목 중에서 선택하세요</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium mb-1">Validation Period (Months) <br> <span class="text-xs text-gray-500">검증 기간 (개월)</span></label>
                <input type="number" name="val_months" value="1" min="1" max="12"
                    class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                <p class="text-[10px] text-gray-400 mt-1 leading-tight">
                    <span class="text-indigo-400 font-bold">Recommended: 1-6 months</span> <br> <span class="font-medium text-indigo-300">권장: 1-6개월</span> (최근 시장국면 최적화)<br>
                    Max: 12 months (최대 12개월: 장기 안정성 체크용)
                </p>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Method <br> <span class="text-xs text-gray-500">수행 방법</span></label>
                <select name="v_type" class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                    <option value="AWO_SCAN_2D" selected>AWO 2D Stability Scan (권장)</option>
                    <option value="DAILY_UPDATE">Lightweight Daily Update (운영)</option>
                </select>
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium mb-1">Min Relevance Score (0-100) <br> <span class="text-xs text-gray-500">최소 관련도 점수 (뉴스 필터링)</span></label>
            <input type="number" name="min_relevance" value="0" min="0" max="100"
                class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600">
            <p class="text-[10px] text-gray-400 mt-1">
                Filter out news with score below this value (Default: 0). <br>
                점수가 이 값보다 낮은 뉴스는 학습에서 제외합니다 (노이즈 제거용). 권장: 10~30.
            </p>
        </div>
        <div>
            <label class="block text-sm font-medium mb-1">Model Type <br> <span class="text-xs text-gray-500">모델 유형</span></label>
            <select name="model_type" class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                <option value="tfidf" selected>TF-IDF Lasso (기본)</option>
                <option value="hybrid">Hybrid TF-IDF + BERT (v1)</option>
                <option value="hybrid_v2">Hybrid v2 (Summary + Tech) ✨</option>
            </select>
            <p class="text-[10px] text-gray-400 mt-1">
                <strong>tfidf:</strong> 전통적인 전체 본문 키워드 분석 <br>
                <strong>hybrid:</strong> 전체 본문 + BERT 임베딩 앙상블 (v1) <br>
                <strong class="text-indigo-500">hybrid_v2: 핵심 추출(Summarization) + 기술적 지표 + BERT ✨</strong><br>
                (본문의 노이즈를 제거하고 핵심 의미 단위로 학습하여 단어 사전의 정밀도가 대폭 향상됩니다.)
            </p>
        </div>

        <div class="bg-gray-50 dark:bg-gray-900/50 p-3 rounded-lg border border-gray-100 dark:border-gray-800">
            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Method Description <br> <span class="normal-case">방법 설명</span></h4>
            <p id="method-desc" class="text-xs text-gray-400 leading-relaxed">
                <!-- Dynamic Content -->
            </p>
        </div>
        
        <script>
            const descriptions = {
                'AWO_SCAN_2D': `<strong>AWO 2D Stability Scan (권장):</strong><br>
                               윈도우 크기(1~12개월)와 Alpha를 동시에 탐색하여 가장 안정적인 모델을 찾고 'Golden Params'를 갱신합니다. 
                               <span class="text-indigo-500 font-bold">Hybrid v2 선택 시 최적의 요약 기반 가중치를 탐색합니다.</span>`,
                'DAILY_UPDATE': `<strong>Lightweight Daily Update (운영):</strong><br>
                                백테스팅을 통해 이미 찾은 'Golden Params'를 사용하여 최신 단어 사전 가중치만 빠르게 재학습합니다 (수 초 내 완료).`
            };
            
            const selectEl = document.querySelector('select[name="v_type"]');
            const descEl = document.getElementById('method-desc');
            
            function updateDesc() {
                descEl.innerHTML = descriptions[selectEl.value] || "";
            }
            
            selectEl.addEventListener('change', updateDesc);
            updateDesc(); // Init
        </script>

        <div class="flex justify-end pt-4">
            <button type="submit" class="btn-primary w-full py-3">Submit Job <br> 작업 제출</button>
        </div>
    </form>
</dialog>
{% endblock %}