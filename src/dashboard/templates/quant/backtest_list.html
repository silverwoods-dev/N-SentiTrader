{% extends "base.html" %}

{% block title %}Backtest Manager - Quant Hub{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Backtest Manager</h1>
            <p class="text-gray-500 text-sm">Validate system configurations using Walk-forward simulation</p>
        </div>
        <button onclick="document.getElementById('new-backtest-modal').showModal()"
            class="btn-primary flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i>
            New Verification Job
        </button>
    </div>

    <!-- Active/Recent Jobs -->
    <div class="bento-card">
        <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
            <i data-lucide="activity" class="w-5 h-5 text-indigo-500"></i>
            Recent Verification Jobs
        </h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job
                            ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Progress</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Started</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-gray-900">
                    {% for job in jobs %}
                    <tr hx-get="/analytics/backtest/row/{{ job.v_job_id }}"
                        hx-trigger="{% if job.status == 'running' %}every 2s{% endif %}" hx-swap="outerHTML">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">#{{ job.v_job_id }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ job.stock_name }} ({{ job.stock_code }})</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">{{ job.v_type }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if job.status == 'completed' %}
                            <span
                                class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Completed</span>
                            {% elif job.status == 'running' %}
                            <span
                                class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 animate-pulse">Running</span>
                            {% elif job.status == 'failed' %}
                            <span
                                class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Failed</span>
                            {% else %}
                            <span
                                class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Pending</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                                <div class="bg-indigo-600 h-2.5 rounded-full" style="width: {{ job.progress }}%"></div>
                            </div>
                            <span class="text-xs text-gray-500 mt-1">{{ job.progress | round(1) }}%</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">{{ job.started_at | kst }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                            {% if job.status == 'completed' %}
                            <a href="/analytics/backtest/report/{{ job.v_job_id }}"
                                class="text-indigo-600 hover:text-indigo-900 font-bold">Report</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not jobs %}
                    <tr>
                        <td colspan="7" class="px-6 py-10 text-center text-gray-500 italic">No verification jobs found.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- New Backtest Modal -->
<dialog id="new-backtest-modal"
    class="modal-box p-0 rounded-2xl bg-white dark:bg-gray-800 text-gray-900 dark:text-white border border-gray-200 dark:border-gray-700 w-full max-w-lg">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
        <h3 class="font-bold text-lg">Create Verification Job</h3>
        <button onclick="document.getElementById('new-backtest-modal').close()"
            class="text-gray-500 hover:text-gray-700">&times;</button>
    </div>
    <form action="/analytics/backtest/create" method="POST" class="p-6 space-y-4">
        <div>
            <label class="block text-sm font-medium mb-1">Stock Code</label>
            <input type="text" name="stock_code" required
                class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600 focus:ring-indigo-500"
                placeholder="e.g. 005930">
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium mb-1">Validation Period (Months)</label>
                <input type="number" name="val_months" value="1" min="1" max="12"
                    class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                <p class="text-[10px] text-gray-400 mt-1">최근 N개월 데이터를 검증셋으로 사용</p>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Method</label>
                <select name="v_type" class="w-full rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600">
                    <option value="AWO_SCAN">Exhaustive AWO Scan (1-11m)</option>
                    <option value="WF_CHECK">Standard Walk-Forward</option>
                </select>
            </div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-900/50 p-3 rounded-lg border border-gray-100 dark:border-gray-800">
            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Notice</h4>
            <p class="text-xs text-gray-400 leading-relaxed">
                AWO 전수 스캔은 11개의 윈도우 시뮬레이션을 병렬로 수행하며, 종목에 따라 수 분에서 수십 분이 소요될 수 있습니다.
                백그라운드에서 실행되므로 페이지를 닫으셔도 안전합니다.
            </p>
        </div>
        <div class="flex justify-end pt-4">
            <button type="submit" class="btn-primary w-full py-3">Start Verification</button>
        </div>
    </form>
</dialog>
{% endblock %}