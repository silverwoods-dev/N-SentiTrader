<!-- partials/validator_timeline.html -->
<!-- TASK-032: Timeline View - 시계열 변화 추적 -->

<div class="space-y-6">
    <!-- Date Range Selector -->
    <div class="bento-card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold flex items-center gap-2">
                <i data-lucide="calendar" class="w-5 h-5 text-indigo-500"></i>
                Select Date Range
            </h3>
        </div>
        <div class="flex gap-2">
            <button hx-get="/analytics/timeline?stock_code={{ stock_code }}&range=7d" hx-target="#view-content"
                hx-swap="innerHTML" hx-indicator="#loading-indicator"
                class="px-4 py-2 rounded-md border-2 {% if range == '7d' %}border-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600{% else %}border-gray-200 dark:border-gray-700{% endif %} text-sm font-semibold hover:border-indigo-400 transition-colors">
                Last 7 Days
            </button>
            <button hx-get="/analytics/timeline?stock_code={{ stock_code }}&range=30d" hx-target="#view-content"
                hx-swap="innerHTML" hx-indicator="#loading-indicator"
                class="px-4 py-2 rounded-md border-2 {% if range == '30d' %}border-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600{% else %}border-gray-200 dark:border-gray-700{% endif %} text-sm font-semibold hover:border-indigo-400 transition-colors">
                Last 30 Days
            </button>
            <button hx-get="/analytics/timeline?stock_code={{ stock_code }}&range=90d" hx-target="#view-content"
                hx-swap="innerHTML" hx-indicator="#loading-indicator"
                class="px-4 py-2 rounded-md border-2 {% if range == '90d' %}border-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600{% else %}border-gray-200 dark:border-gray-700{% endif %} text-sm font-semibold hover:border-indigo-400 transition-colors">
                Last 90 Days
            </button>
        </div>
    </div>

    <!-- Word Weight Heatmap -->
    <div class="bento-card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold flex items-center gap-2">
                <i data-lucide="layout-grid" class="w-5 h-5 text-indigo-500"></i>
                Word Weight Heatmap (Evolution)
            </h3>
            <span class="text-xs text-gray-400">Color depth represents Beta magnitude</span>
        </div>
        <div class="h-[500px]">
            <canvas id="timelineHeatmap"></canvas>
        </div>
    </div>

    <!-- Data Table -->
    <div class="bento-card overflow-hidden">
        <h3 class="text-lg font-bold mb-4">Main Dictionary History</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr
                        class="text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-100 dark:border-gray-700">
                        <th class="px-4 py-3">Date</th>
                        <th class="px-4 py-3">Word</th>
                        <th class="px-4 py-3">Beta</th>
                        <th class="px-4 py-3">Version</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {% for item in main_data %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer group"
                        onclick="showGrounding('{{ item['word'] }}', '{{ item['updated_at'].strftime('%Y-%m-%d') }}')">
                        <td class="px-4 py-3 font-mono text-xs">{{ item['updated_at'].strftime('%Y-%m-%d') }}</td>
                        <td class="px-4 py-3 text-sm group-hover:text-indigo-600 transition-colors">{{ item['word'] }}
                        </td>
                        <td
                            class="px-4 py-3 font-mono text-sm {% if item['beta'] > 0 %}text-green-500{% else %}text-red-500{% endif %}">
                            {{ "%.4f"|format(item['beta']) }}
                        </td>
                        <td class="px-4 py-3 text-xs text-gray-500">{{ item['version'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Heatmap Rendering
    (function () {
        const wordSeries = {{ word_series | tojson
    }};
    const topWords = {{ top_words | tojson }};

    const ctx = document.getElementById('timelineHeatmap').getContext('2d');
    const matrixData = [];

    topWords.forEach(word => {
        if (wordSeries[word]) {
            wordSeries[word].forEach(d => {
                matrixData.push({
                    x: d.date,
                    y: word,
                    v: d.beta
                });
            });
        }
    });

    if (Chart.getChart('timelineHeatmap')) {
        Chart.getChart('timelineHeatmap').destroy();
    }

    new Chart(ctx, {
        type: 'matrix',
        data: {
            datasets: [{
                label: 'Word Beta',
                data: matrixData,
                backgroundColor(context) {
                    const val = context.dataset.data[context.dataIndex].v;
                    const alpha = Math.min(Math.abs(val) * 5, 1); // Scale intensity
                    return val > 0 ? `rgba(16, 185, 129, ${alpha})` : `rgba(239, 68, 68, ${alpha})`;
                },
                width: ({ chart }) => (chart.chartArea || {}).width / 30 - 1,
                height: ({ chart }) => (chart.chartArea || {}).height / topWords.length - 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'day', displayFormats: { day: 'MM-dd' } },
                    ticks: { source: 'auto' },
                    grid: { display: false }
                },
                y: {
                    type: 'category',
                    labels: topWords,
                    grid: { display: false }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: () => '',
                        label(context) {
                            const item = context.dataset.data[context.dataIndex];
                            return [`Word: ${item.y}`, `Date: ${item.x}`, `Beta: ${item.v.toFixed(4)}`];
                        }
                    }
                }
            },
            onClick: (e, items) => {
                if (items.length > 0) {
                    const item = matrixData[items[0].index];
                    showGrounding(item.y, item.x);
                }
            }
        }
    });
    }) ();
</script>