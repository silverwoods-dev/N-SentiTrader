<!-- partials/validator_timeline.html -->
<!-- TASK-032: Timeline View - 시계열 변화 추적 -->

<div class="space-y-6">
    <!-- Date Range Selector -->
    <div class="bento-card">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold flex items-center gap-2">
                <i data-lucide="calendar" class="w-5 h-5 text-indigo-500"></i>
                Select Date Range
            </h3>
        </div>
        <div class="flex gap-2">
            <button hx-get="/analytics/timeline?stock_code={{ stock_code }}&range=7d" hx-target="#view-content"
                hx-swap="innerHTML" hx-indicator="#loading-indicator"
                class="px-4 py-2 rounded-md border-2 {% if range == '7d' %}border-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600{% else %}border-gray-200 dark:border-gray-700{% endif %} text-sm font-semibold hover:border-indigo-400 transition-colors">
                Last 7 Days
            </button>
            <button hx-get="/analytics/timeline?stock_code={{ stock_code }}&range=30d" hx-target="#view-content"
                hx-swap="innerHTML" hx-indicator="#loading-indicator"
                class="px-4 py-2 rounded-md border-2 {% if range == '30d' %}border-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600{% else %}border-gray-200 dark:border-gray-700{% endif %} text-sm font-semibold hover:border-indigo-400 transition-colors">
                Last 30 Days
            </button>
            <button hx-get="/analytics/timeline?stock_code={{ stock_code }}&range=90d" hx-target="#view-content"
                hx-swap="innerHTML" hx-indicator="#loading-indicator"
                class="px-4 py-2 rounded-md border-2 {% if range == '90d' %}border-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600{% else %}border-gray-200 dark:border-gray-700{% endif %} text-sm font-semibold hover:border-indigo-400 transition-colors">
                Last 90 Days
            </button>
        </div>
    </div>

    <!-- Word Trends: Vanguard & Derelict -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bento-card border-l-4 border-emerald-500">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold flex items-center gap-2 text-emerald-600 dark:text-emerald-400">
                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                    Vanguard (New Entries)
                </h3>
                <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full">Recent 7 Days</span>
            </div>
            <div class="space-y-2">
                {% if vanguard %}
                {% for item in vanguard[:10] %}
                <div
                    class="flex justify-between items-center text-sm p-2 bg-emerald-50/50 dark:bg-emerald-900/10 rounded-lg">
                    <span class="font-semibold">{{ item.word }}</span>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-400">{{ item.updated_at.strftime('%m-%d') }}</span>
                        <span class="font-mono text-emerald-600 font-bold">{{ "+%.4f"|format(item.beta) }}</span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-sm text-gray-400 italic py-4 text-center">No new words detected in this period.</p>
                {% endif %}
            </div>
        </div>

        <div class="bento-card border-l-4 border-rose-500">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold flex items-center gap-2 text-rose-600 dark:text-rose-400">
                    <i data-lucide="trending-down" class="w-5 h-5"></i>
                    Derelict (Exited)
                </h3>
                <span class="text-xs bg-rose-100 text-rose-700 px-2 py-0.5 rounded-full">Recent 7 Days</span>
            </div>
            <div class="space-y-2">
                {% if derelict %}
                {% for item in derelict[:10] %}
                <div class="flex justify-between items-center text-sm p-2 bg-rose-50/50 dark:bg-rose-900/10 rounded-lg">
                    <span class="font-semibold text-gray-500 line-through">{{ item.word }}</span>
                    <div class="flex items-center gap-3">
                        <span class="text-xs text-gray-400">Was: {{ item.updated_at.strftime('%m-%d') }}</span>
                        <span class="font-mono text-rose-500">{{ "%.4f"|format(item.beta) }}</span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-sm text-gray-400 italic py-4 text-center">No words exited the dictionary recently.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Word Weight Heatmap -->
    <div class="bento-card">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-indigo-100 dark:bg-indigo-900/40 rounded-lg">
                    <i data-lucide="layout-grid" class="w-5 h-5 text-indigo-600 dark:text-indigo-400"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold">Word Weight Heatmap</h3>
                    <p class="text-xs text-gray-500">How word weights evolved over time (Top 20 Active Words)</p>
                </div>
            </div>
            <div class="flex items-center gap-4 text-[10px] uppercase font-bold tracking-widest text-gray-400">
                <span class="flex items-center gap-1"><span class="w-2 h-2 bg-rose-500 rounded-full"></span>
                    Negative</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 bg-emerald-500 rounded-full"></span>
                    Positive</span>
            </div>
        </div>
        <div class="space-y-2">
            <!-- News Pulse Chart (Top) -->
            <div class="h-[120px] mb-2 border-b border-gray-100 dark:border-gray-700 pb-2">
                <canvas id="pulseChart"></canvas>
            </div>
            <!-- Heatmap Chart (Bottom) -->
            <div class="h-[450px]">
                <canvas id="timelineHeatmap"></canvas>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="bento-card overflow-hidden">
        <h3 class="text-lg font-bold mb-4">Main Dictionary History</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr
                        class="text-xs font-bold text-gray-500 uppercase tracking-wider border-b border-gray-100 dark:border-gray-700">
                        <th class="px-4 py-3">Date</th>
                        <th class="px-4 py-3">Word</th>
                        <th class="px-4 py-3">Beta</th>
                        <th class="px-4 py-3">Version</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {% for item in main_data %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer group"
                        onclick="showGrounding('{{ item['word'] }}', '{{ item['updated_at'].strftime('%Y-%m-%d') }}')">
                        <td class="px-4 py-3 font-mono text-xs">{{ item['updated_at'].strftime('%Y-%m-%d') }}</td>
                        <td class="px-4 py-3 text-sm group-hover:text-indigo-600 transition-colors">{{ item['word'] }}
                        </td>
                        <td
                            class="px-4 py-3 font-mono text-sm {% if item['beta'] > 0 %}text-green-500{% else %}text-red-500{% endif %}">
                            {{ "%.4f"|format(item['beta']) }}
                        </td>
                        <td class="px-4 py-3 text-xs text-gray-500">{{ item['version'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Heatmap Rendering
    (function () {
        const wordSeries = {{ word_series | tojson }};
    const topWords = {{ top_words | tojson }};
    const pulseData = {{ pulse_data | tojson }};

    // 1. News Pulse (Bar Chart)
    const pulseCtx = document.getElementById('pulseChart').getContext('2d');
    const avgVolume = pulseData.length > 0 ? pulseData.reduce((a, b) => a + b.count, 0) / pulseData.length : 0;

    new Chart(pulseCtx, {
        type: 'bar',
        data: {
            labels: pulseData.map(d => d.date),
            datasets: [{
                data: pulseData.map(d => d.count),
                backgroundColor: pulseData.map(d => d.count > avgVolume * 2 ? 'rgba(79, 70, 229, 0.8)' : 'rgba(79, 70, 229, 0.2)'),
                borderRadius: 4,
                barPercentage: 0.8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { type: 'time', time: { unit: 'day' }, display: false, grid: { display: false } },
                y: { beginAtZero: true, display: false, grid: { display: false } }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.9)',
                    titleFont: { size: 12, weight: 'bold' },
                    bodyFont: { size: 11 },
                    padding: 12,
                    callbacks: {
                        title: (items) => `Daily Pulse: ${items[0].label}`,
                        label: (item) => {
                            const d = pulseData[item.dataIndex];
                            let lines = [`Volume: ${d.count} news items`];
                            if (d.headlines && d.headlines.length > 0) {
                                lines.push('-------------------');
                                d.headlines.forEach(h => lines.push(`• ${h}`));
                            }
                            return lines;
                        }
                    }
                }
            }
        }
    });

    // 2. Heatmap Rendering (Synced X-axis)
    const ctx = document.getElementById('timelineHeatmap').getContext('2d');
    const matrixData = [];

    topWords.forEach(word => {
        if (wordSeries[word]) {
            wordSeries[word].forEach(d => {
                matrixData.push({ x: d.date, y: word, v: d.beta });
            });
        }
    });

    if (Chart.getChart('timelineHeatmap')) {
        Chart.getChart('timelineHeatmap').destroy();
    }

    new Chart(ctx, {
        type: 'matrix',
        data: {
            datasets: [{
                label: 'Word Beta',
                data: matrixData,
                backgroundColor(context) {
                    const val = context.dataset.data[context.dataIndex].v;
                    const alpha = Math.min(Math.abs(val) * 10, 0.9);
                    return val > 0 ? `rgba(16, 185, 129, ${alpha})` : `rgba(239, 68, 68, ${alpha})`;
                },
                borderColor(context) {
                    const val = context.dataset.data[context.dataIndex].v;
                    return val > 0 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                },
                borderWidth: 1,
                width: ({ chart }) => (chart.chartArea || {}).width / 31 - 2,
                height: ({ chart }) => (chart.chartArea || {}).height / topWords.length - 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { left: 10, right: 20 } },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'day', displayFormats: { day: 'MM-dd' } },
                    ticks: { source: 'auto', font: { size: 10 } },
                    grid: { display: false }
                },
                y: {
                    type: 'category',
                    labels: topWords,
                    grid: { display: false },
                    ticks: { font: { size: 11, weight: 'bold' } }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        title: () => '',
                        label(context) {
                            const item = context.dataset.data[context.dataIndex];
                            return [`Word: ${item.y}`, `Date: ${item.x}`, `Beta: ${item.v.toFixed(4)}`];
                        }
                    }
                }
            },
            onClick: (e, items) => {
                if (items.length > 0) {
                    const item = matrixData[items[0].index];
                    showGrounding(item.y, item.x);
                }
            }
        }
    });
    }) ();
</script>