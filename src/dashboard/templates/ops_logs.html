{% extends "base.html" %}

{% block title %}Ops Center - N-SentiTrader{% endblock %}

{% block head %}
<style>
    .glass-panel {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .terminal-container {
        background: #0d1117;
        font-family: 'Fira Code', 'Cascadia Code', monospace;
        color: #e6edf3;
        border: 1px solid #30363d;
        border-radius: 0.75rem;
    }
    .terminal-content {
        scrollbar-width: thin;
        scrollbar-color: #30363d transparent;
    }
    .terminal-content::-webkit-scrollbar {
        width: 6px;
    }
    .terminal-content::-webkit-scrollbar-thumb {
        background-color: #30363d;
        border-radius: 10px;
    }
    .active-container {
        background: rgba(59, 130, 246, 0.1);
        border-right: 3px solid #3b82f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col gap-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold">Operations Center</h1>
            <p class="text-gray-500 text-sm">Real-time container monitoring and log analysis</p>
        </div>
        <div class="flex gap-3">
             <button onclick="location.reload()" class="p-2 border rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                 <i data-lucide="refresh-cw" class="w-5 h-5"></i>
             </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 min-h-[600px]">
        <!-- Container Sidebar -->
        <div class="md:col-span-1 bento-card p-0 overflow-hidden flex flex-col">
            <div class="p-4 border-b border-gray-100 dark:border-gray-700">
                <h3 class="font-semibold text-sm uppercase tracking-wider text-gray-400">Worker Containers</h3>
            </div>
            <nav class="flex-1 overflow-y-auto py-2" id="container-sidebar">
                <!-- Loaded via JS -->
                <div class="flex items-center justify-center p-8 text-gray-400">
                    <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>
                </div>
            </nav>
        </div>

        <!-- Log Viewer Area -->
        <div class="md:col-span-3 flex flex-col gap-4">
            <div class="bento-card p-4 flex justify-between items-center glass-panel">
                <div class="flex items-center gap-3">
                    <div id="active-dot" class="w-2.5 h-2.5 rounded-full bg-gray-400 animate-pulse"></div>
                    <div>
                        <h2 id="selected-name" class="font-bold">Select a container</h2>
                        <span id="selected-id" class="text-xs text-gray-500 font-mono">---</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <select id="log-tail" class="bg-transparent border border-gray-200 dark:border-gray-700 rounded-lg px-2 py-1 text-xs outline-none">
                        <option value="100">Tail 100</option>
                        <option value="200" selected>Tail 200</option>
                        <option value="500">Tail 500</option>
                        <option value="1000">Tail 1000</option>
                    </select>
                    <div class="flex items-center gap-2 text-xs text-gray-500">
                        <i data-lucide="clock" class="w-3 h-3"></i>
                        <span>Auto-refresh: 3s</span>
                    </div>
                </div>
            </div>

            <!-- Terminal Output -->
            <div class="terminal-container flex-1 relative overflow-hidden flex flex-col min-h-[500px]">
                <div id="log-output" 
                     class="terminal-content p-4 flex-1 overflow-y-auto text-sm leading-relaxed"
                     hx-get="" hx-trigger="every 3s" hx-target="this" hx-swap="innerHTML">
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 opacity-50">
                        <i data-lucide="terminal" class="w-12 h-12 mb-4"></i>
                        <p>Select a worker to view live logs</p>
                    </div>
                </div>
                
                <!-- Terminal Toolbar -->
                <div class="p-2 border-t border-[#30363d] bg-[#161b22]/50 flex justify-between items-center">
                    <div class="flex gap-2">
                        <div class="w-3 h-3 rounded-full bg-[#ff5f56]"></div>
                        <div class="w-3 h-3 rounded-full bg-[#ffbd2e]"></div>
                        <div class="w-3 h-3 rounded-full bg-[#27c93f]"></div>
                    </div>
                    <div class="flex gap-3">
                        <button id="restart-btn" class="flex items-center gap-1 px-3 py-1 rounded bg-red-600/20 text-red-400 hover:bg-red-600/30 text-xs font-medium transition-colors opacity-50 pointer-events-none">
                            <i data-lucide="power" class="w-3 h-3"></i>
                            <span>Restart Container</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function initOps() {
        const sidebar = document.getElementById('container-sidebar');
        const resp = await fetch('/system/containers');
        const data = await resp.json();
        
        sidebar.innerHTML = '';
        data.containers.forEach(c => {
            const el = document.createElement('div');
            el.className = 'px-4 py-3 flex items-center justify-between cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors group';
            el.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400">
                        <i data-lucide="box" class="w-4 h-4"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-sm font-medium">${c.name}</span>
                        <span class="text-[10px] text-gray-500 font-mono">${c.id}</span>
                    </div>
                </div>
                <i data-lucide="chevron-right" class="w- transition-transform group-hover:translate-x-1 opacity-0 group-hover:opacity-100 text-gray-300"></i>
            `;
            el.onclick = () => selectContainer(c, el);
            sidebar.appendChild(el);
        });
        lucide.createIcons();
    }

    function selectContainer(container, element) {
        // Update UI
        document.querySelectorAll('#container-sidebar > div').forEach(d => d.classList.remove('active-container'));
        element.classList.add('active-container');
        
        document.getElementById('selected-name').innerText = container.name;
        document.getElementById('selected-id').innerText = container.id;
        document.getElementById('active-dot').classList.remove('bg-gray-400');
        document.getElementById('active-dot').classList.add('bg-green-500');
        
        // Setup HTMX for logs
        const logArea = document.getElementById('log-output');
        const tail = document.getElementById('log-tail').value;
        logArea.setAttribute('hx-get', `/system/logs/${container.id}?tail=${tail}`);
        htmx.process(logArea);
        
        // Initial manual trigger
        htmx.trigger(logArea, 'refresh');
        
        // Enable restart button
        const btn = document.getElementById('restart-btn');
        btn.classList.remove('opacity-50', 'pointer-events-none');
        btn.onclick = () => restartContainer(container.id);
        
        // Scroll to bottom after load
        const observer = new MutationObserver(() => {
            logArea.scrollTop = logArea.scrollHeight;
        });
        observer.observe(logArea, { childList: true });
    }

    async function restartContainer(id) {
        if (!confirm(`Are you sure you want to restart ${id}?`)) return;
        
        const btn = document.getElementById('restart-btn');
        btn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i><span>Restarting...</span>';
        lucide.createIcons();
        
        try {
            // Simplified: Use the existing restart all logic or similar if needed.
            // For now, let's assume we might need a specific restart endpoint.
            // I'll add one to admin.py in the next step or reuse.
            // For now, let's use the generic restart logic if I had implemented it.
            // Wait, restart_container in docker_control takes a name.
            // I should add a POST /system/restart/{container_id}
            const resp = await fetch(`/system/restart/${id}`, { method: 'POST' });
            const data = await resp.json();
            if (data.status === 'success') {
                showToast(`Container ${id} restarted successfully.`);
            } else {
                showToast(`Failed to restart ${id}: ${data.msg}`, 'error');
            }
        } catch (e) {
            showToast(`Error: ${e}`, 'error');
        } finally {
            btn.innerHTML = '<i data-lucide="power" class="w-3 h-3"></i><span>Restart Container</span>';
            lucide.createIcons();
        }
    }

    window.onload = initOps;
</script>
{% endblock %}
