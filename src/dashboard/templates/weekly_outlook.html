{% extends "base.html" %}

{% block title %}Weekly Market Weather - {{ stock_name }}{% endblock %}

{% block head %}
<style>
    .weather-card {
        @apply flex flex-col items-center justify-center p-4 rounded-3xl transition-all duration-300;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .weather-card:hover {
        @apply scale-105;
        background: rgba(255, 255, 255, 0.1);
    }
    .status-sun { @apply text-amber-400 bg-amber-400/10; }
    .status-cloud { @apply text-gray-400 bg-gray-400/10; }
    .status-rain { @apply text-blue-400 bg-blue-400/10; }
    .status-storm { @apply text-indigo-400 bg-indigo-400/10; }
    .status-fog { @apply text-rose-400 bg-rose-400/10; }
</style>
{% endblock %}

{% block content %}
{% set status_map = {
    'Super Buy': '강력 매수',
    'Strong Buy': '강력 매수',
    'Cautious Buy': '주의 매수',
    'Limited Buy': '제한적 매수',
    'Super Sell': '강력 매도',
    'Strong Sell': '강력 매도',
    'Cautious Sell': '주의 매도',
    'Limited Sell': '제한적 매도',
    'Hold': '관망',
    'Wait': '대기',
    'Neutral': '중립',
    'Restricted': '거래 제한',
    'PENDING': '분석 중',
    'HOLIDAY': '휴장',
    'CLOSED': '휴장',
    'D-Day': '도래 예정'
} %}
<div class="space-y-8 max-w-6xl mx-auto">
    <!-- Header: Stock at a Glance -->
    <div class="flex flex-col md:flex-row justify-between items-end gap-6">
        <div>
            <div class="flex items-center gap-4 mb-2">
                <h1 class="text-4xl font-black">{{ stock_name }}</h1>
                <span class="px-3 py-1 bg-gray-100 dark:bg-gray-800 rounded-full text-xs font-bold text-gray-500">{{ stock_code }}</span>
            </div>
            <p class="text-gray-500 text-lg">Weekly Investment Forecast & Valuation Outlook<br><span class="text-sm opacity-70">주간 투자 예보 및 밸류에이션 전망</span></p>
            
            <!-- AI Narrative -->
            {% if weekly_outlook.narrative %}
            <div class="mt-4 p-4 rounded-2xl bg-gradient-to-r from-gray-50 to-white dark:from-gray-800/50 dark:to-gray-900/10 border border-gray-200/50 dark:border-gray-700/50 shadow-sm">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center shrink-0">
                        <i data-lucide="sparkles" class="w-4 h-4 text-indigo-600 dark:text-indigo-400"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-800 dark:text-gray-200 leading-snug font-medium mb-1.5">
                            {{ weekly_outlook.narrative.en|safe }}
                        </p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 leading-snug">
                            {{ weekly_outlook.narrative.kr|safe }}
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="flex gap-4">
            <!-- Simplified Valuation Gauge -->
            <div class="px-6 py-4 rounded-3xl bg-{{ weekly_outlook.fundamentals.valuation_color }}-50 dark:bg-{{ weekly_outlook.fundamentals.valuation_color }}-900/20 border border-{{ weekly_outlook.fundamentals.valuation_color }}-200 dark:border-{{ weekly_outlook.fundamentals.valuation_color }}-800/50">
                <span class="text-[10px] font-bold uppercase text-{{ weekly_outlook.fundamentals.valuation_color }}-500 block mb-1">Price Context 가격 맥락</span>
                <span class="text-xl font-black text-{{ weekly_outlook.fundamentals.valuation_color }}-600 dark:text-{{ weekly_outlook.fundamentals.valuation_color }}-400">
                    {{ weekly_outlook.fundamentals.valuation_label }}
                </span>
            </div>
            
            <a href="/analytics/expert?stock_code={{ stock_code }}" class="flex items-center gap-2 px-6 py-4 rounded-3xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold transition-all shadow-lg shadow-indigo-500/20">
                <i data-lucide="microscope" class="w-5 h-5"></i>
                Expert Mode<br>
                전문가 모드<br>
            </a>
        </div>
    </div>

    <!-- Phase 10: Model Lineage & Trust Intel -->
    <div class="flex items-center gap-4 p-3 px-5 rounded-2xl bg-indigo-50/50 dark:bg-indigo-900/10 border border-indigo-100 dark:border-indigo-800/30">
        <!-- Icon: Window Size Only -->
        <div class="w-10 h-10 rounded-full bg-emerald-500 shadow-lg shadow-emerald-500/30 flex items-center justify-center text-xs text-white font-black border-2 border-white dark:border-gray-900 shrink-0">
            {{ model_info.tag }}
        </div>
        
        <!-- Text Info -->
        <div class="text-[10px] text-indigo-900/60 dark:text-indigo-400/60 font-medium leading-relaxed">
            <span class="font-bold text-indigo-600 dark:text-indigo-400 text-xs">
                Active Model (Lasso)
            </span>
            <span class="mx-1 opacity-50">|</span>
            <span class="font-mono">α={{ "%.3f"|format(model_info.alpha) if model_info.alpha else '0.01' }}</span><br>
            
            <span>Train: <span class="text-indigo-700 dark:text-indigo-300">{{ model_info.period_en }}</span></span><br>
            
            <span class="flex items-center gap-1 mt-0.5">
                Status: 
                <span class="bg-indigo-100 dark:bg-indigo-800 px-1.5 py-0.5 rounded text-[9px] font-bold text-indigo-700 dark:text-indigo-300">
                    {{ model_info.verification_en }}
                </span>
            </span>
        </div>
    </div>

    <!-- MAIN FORECAST: 10-Day Weather Tiles -->
    <div class="space-y-6">
        <!-- Disclaimer Alert -->
        <div class="flex items-start gap-4 p-4 rounded-2xl bg-amber-50 dark:bg-amber-900/20 border border-amber-200/50 dark:border-amber-800/30">
            <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-500 mt-0.5 shrink-0"></i>
            <div>
                <p class="text-xs font-bold text-amber-700 dark:text-amber-400">Notice on Accuracy | 정확도 고지</p>
                <p class="text-[10px] text-amber-600/80 dark:text-amber-400/60 leading-tight">
                    Next-week forecasts are based on current sentiment decay. Accuracy may decrease as future news events occur. Updated daily.<br>
                    다음 주 전망은 현재의 감성 잔류 로직에 기반합니다. 미래에 새로운 뉴스가 발생함에 따라 정확도가 변동될 수 있으며, 매일 업데이트됩니다.
                </p>
            </div>
        </div>
        
        <!-- Legal Disclaimer -->
        <div class="flex items-start gap-4 p-4 rounded-2xl bg-gray-50 dark:bg-gray-800/20 border border-gray-100 dark:border-gray-700/50">
            <i data-lucide="shield-alert" class="w-5 h-5 text-gray-400 mt-0.5 shrink-0"></i>
            <div>
                <p class="text-xs font-bold text-gray-500 dark:text-gray-400">Legal Disclaimer | 투자 유의사항 및 면책 공지</p>
                <div class="text-[10px] text-gray-400 dark:text-gray-500 leading-relaxed space-y-2 mt-1">
                    <p>
                        The predictions and analysis provided by this system are based on historical data patterns and sentiment analysis algorithms. 
                        They do *not* guarantee future market performance and should *not* be construed as financial advice.
                        <br>
                        본 시스템이 제공하는 예측 및 분석 정보는 과거 데이터 패턴과 감성 분석 알고리즘에 기초한 참고 자료일 뿐입니다. 
                        이는 미래의 시장 성과를 보장하지 않으며, 결코 재무적 조언으로 해석되어서는 안 됩니다.
                    </p>
                    <p>
                        Investment decisions involve risk, including the potential loss of principal. 
                        All final investment decisions and their consequences are the sole responsibility of the user. 
                        We assume no liability for any losses incurred based on these predictions.
                        <br>
                        투자는 원금 손실의 위험을 수반합니다. 
                        모든 최종 투자 결정과 그 결과에 대한 책임은 전적으로 사용자 본인에게 있습니다. 
                        본 시스템의 예측에 따른 어떠한 손실에 대해서도 당사는 법적 책임을 지지 않습니다.
                    </p>
                </div>
            </div>
        </div>
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- THIS WEEK -->
            <div class="bento-card p-6 bg-gradient-to-br from-indigo-500/5 to-purple-500/5 border-indigo-500/10">
                <h3 class="text-sm font-bold mb-6 flex items-center gap-2 uppercase tracking-widest text-gray-400">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    This Week<br><span class="text-[10px] opacity-70">이번 주</span>
                </h3>
                <div class="grid grid-cols-5 gap-3">
                    {% for item in weekly_outlook.outlook[:5] %}
                    <div class="weather-card p-3 rounded-2xl cursor-pointer group/card transition-all
                                {% if item.is_correct is not none and item.status != 'HOLIDAY' %}
                                    {% if item.is_correct %}
                                        bg-emerald-500/10 border border-emerald-500/30
                                    {% else %}
                                        bg-rose-500/10 border border-rose-500/30
                                    {% endif %}
                                {% elif item.status == 'HOLIDAY' %}
                                    bg-gray-100 dark:bg-white/5 border border-gray-200 dark:border-white/10 opacity-60
                                {% elif 'Buy' in item.status %}
                                    bg-amber-500/5 border border-amber-500/30
                                {% elif 'Sell' in item.status %}
                                    bg-indigo-500/5 border border-indigo-500/30
                                {% else %}
                                    bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 hover:border-indigo-400/30
                                {% endif %}" 
                         onclick="openNewsModal('{{ item.date }}')">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-bold text-gray-400 group-hover/card:text-indigo-400 transition-colors">{{ item.date[5:] }}</span>
                            {% if item.is_correct is not none and item.status != 'HOLIDAY' %}
                                {% if item.is_correct %}
                                    <i data-lucide="check-circle-2" class="w-3 h-3 text-emerald-500"></i>
                                {% else %}
                                    <i data-lucide="x-circle" class="w-3 h-3 text-rose-500"></i>
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            {% if item.status == 'HOLIDAY' %}
                                <i data-lucide="moon-star" class="w-8 h-8 text-indigo-400 opacity-50"></i>
                            {% elif item.status == 'PENDING' %}
                                <i data-lucide="timer" class="w-8 h-8 text-gray-300 animate-pulse"></i>
                            {% elif 'Buy' in item.status %}
                                <i data-lucide="sun" class="w-8 h-8 text-amber-500"></i>
                            {% elif 'Sell' in item.status %}
                                <i data-lucide="cloud-lightning" class="w-8 h-8 text-indigo-500"></i>
                            {% elif 'Restricted' in item.status %}
                                <i data-lucide="cloud-off" class="w-8 h-8 text-rose-500"></i>
                            {% else %}
                                <i data-lucide="cloud" class="w-8 h-8 text-gray-400"></i>
                            {% endif %}
                        </div>
                        <span class="text-[9px] font-black uppercase tracking-tighter truncate w-full text-center group-hover/card:text-indigo-400 transition-colors">
                            {{ 'CLOSED' if item.status == 'HOLIDAY' else item.status }}<br>
                            <span class="text-[8px] opacity-60 normal-case">{{ status_map.get(item.status, '') }}</span>
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- NEXT WEEK -->
            <div class="bento-card p-6 bg-gradient-to-br from-emerald-500/5 to-teal-500/5 border-emerald-500/10">
                <h3 class="text-sm font-bold mb-6 flex items-center gap-2 uppercase tracking-widest text-gray-400">
                    <i data-lucide="forward" class="w-4 h-4"></i>
                    Next Week (Projected)<br><span class="text-[10px] opacity-70">다음 주 (예상)</span>
                </h3>
                <div class="grid grid-cols-5 gap-3">
                    {% for item in weekly_outlook.outlook[5:] %}
                    <div class="weather-card p-3 rounded-2xl cursor-pointer group/card transition-all
                                {% if item.status == 'HOLIDAY' %}
                                    bg-gray-100 dark:bg-white/5 border border-gray-200 dark:border-white/10 opacity-60
                                {% elif 'Buy' in item.status %}
                                    bg-amber-500/5 border border-amber-500/30
                                {% elif 'Sell' in item.status %}
                                    bg-indigo-500/5 border border-indigo-500/30
                                {% else %}
                                    bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 hover:border-indigo-400/30
                                {% endif %}"
                         onclick="openNewsModal('{{ item.date }}')">
                        <span class="text-[10px] font-bold text-gray-400 mb-2 group-hover/card:text-indigo-400 transition-colors">{{ item.date|truncate(5, True, '') }}</span>
                        <div class="mb-3">
                            {% if item.status == 'HOLIDAY' %}
                                <i data-lucide="moon-star" class="w-8 h-8 text-indigo-400 opacity-50"></i>
                            {% elif item.status == 'PENDING' %}
                                <i data-lucide="sparkles" class="w-8 h-8 text-emerald-400/40"></i>
                            {% elif 'Buy' in item.status %}
                                <i data-lucide="sun" class="w-8 h-8 text-amber-500 opacity-60"></i>
                            {% elif 'Sell' in item.status %}
                                <i data-lucide="cloud-lightning" class="w-8 h-8 text-indigo-500 opacity-60"></i>
                            {% else %}
                                <i data-lucide="cloud" class="w-8 h-8 text-gray-300 opacity-50"></i>
                            {% endif %}
                        </div>
                        <span class="text-[9px] font-black uppercase tracking-tighter truncate w-full text-center text-gray-500 group-hover/card:text-indigo-400 transition-colors">
                            {{ 'D-Day' if item.status == 'PENDING' else item.status }}<br>
                            <span class="text-[8px] opacity-60 normal-case">{{ status_map.get(item.status, '도래 예정' if item.status == 'PENDING' else '') }}</span>
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        </div>
    </div>
    
    <!-- Phase 47: Historical Signals Timeline -->
    <div class="mt-8 mb-8">
        <h3 class="text-sm font-bold mb-6 flex items-center gap-2 uppercase tracking-widest text-gray-500 dark:text-gray-400 pl-2 border-l-4 border-indigo-500">
            Historical Signals | 과거 신호 기록
            <span class="ml-auto text-[10px] normal-case bg-indigo-500/10 text-indigo-400 px-2 py-0.5 rounded-full">
                Past Performance
            </span>
        </h3>
        
        <div id="history-container" class="space-y-6">
            {% include "partials/history_rows.html" %}
        </div>
        
        <!-- Load More Button -->
        <div class="mt-8 text-center">
            <button onclick="loadMoreHistory()" 
                    class="px-8 py-3 rounded-xl bg-gradient-to-r from-gray-100 to-white dark:from-gray-800 dark:to-gray-900 border border-gray-200 dark:border-gray-800 hover:border-indigo-500/30 text-xs font-bold text-gray-500 dark:text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 transition-all flex items-center gap-2 mx-auto shadow-lg shadow-gray-200/50 dark:shadow-none group">
                <i data-lucide="history" class="w-4 h-4 group-hover:rotate-180 transition-transform duration-500"></i>
                Load More History (과거 기록 더 보기)
            </button>
        </div>
        
        <script>
            let historyOffset = 10;
            async function loadMoreHistory() {
                const btn = document.querySelector('button[onclick="loadMoreHistory()"]');
                const origContent = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Loading...';
                btn.disabled = true;
                
                try {
                    const response = await fetch(`/analytics/history_partial?stock_code={{ stock_code }}&offset=${historyOffset}`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const html = await response.text();
                    
                    if (html.trim().length > 0) {
                        const container = document.getElementById('history-container');
                        container.insertAdjacentHTML('beforeend', html);
                        historyOffset += 10;
                        lucide.createIcons();
                    } else {
                        btn.innerHTML = 'No more history';
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                        return;
                    }
                } catch (error) {
                    console.error('Error loading history:', error);
                    btn.innerHTML = 'Error loading';
                }
                
                btn.innerHTML = origContent;
                btn.disabled = false;
            }
        </script>
    </div>

    <!-- Phase 48: Legacy Table Removed -->
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Performance Summary (Simplified) -->
        <div class="bento-card p-8">
            <h3 class="text-lg font-bold mb-6 flex items-center gap-2">
                <i data-lucide="trending-up" class="text-emerald-500"></i>
                Current Week Success<br><span class="text-xs text-gray-400">이번 주 예측 성공률</span>
            </h3>
            <div class="flex items-end gap-2 mb-4">
                <span class="text-6xl font-black text-emerald-500">{{ weekly_perf.hit_rate }}%</span>
                <span class="text-gray-400 mb-2 font-bold">ACCURACY<br>성공률</span>
            </div>
            <div class="flex gap-1 h-3 mb-6">
                {% for day in weekly_perf.details %}
                    <div class="flex-1 rounded-full {% if day.is_correct %}bg-emerald-500{% else %}bg-rose-400{% endif %}"></div>
                {% endfor %}
            </div>
            <p class="text-sm text-gray-500">
                The AI model correctly predicted {{ weekly_perf.correct_days }} out of {{ weekly_perf.total_days }} market sessions this week.<br>
                AI 모델이 이번 주 {{ weekly_perf.total_days }}회 중 {{ weekly_perf.correct_days }}회의 시장 방향을 정확히 예측했습니다.
            </p>
        </div>

        <!-- Drivers Summary -->
        <div class="bento-card p-8">
            <h3 class="text-lg font-bold mb-6 flex items-center gap-2">
                <i data-lucide="waves" class="text-blue-500"></i>
                Sentiment Radar<br><span class="text-xs text-gray-400">감성 레이더</span>
            </h3>
            <div class="grid grid-cols-2 gap-6">
                <!-- Positive Channel -->
                <div class="space-y-3">
                    <p class="text-xs font-bold text-emerald-600 dark:text-emerald-400 uppercase tracking-wider border-b border-emerald-100 dark:border-emerald-900 pb-1">Positive Drivers</p>
                    {% if weekly_outlook.pulse_words.positive %}
                        {% for item in weekly_outlook.pulse_words.positive %}
                        <div class="flex justify-between items-center px-4 py-2 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400 border border-emerald-100 dark:border-emerald-800/30">
                            <span class="font-bold text-sm truncate pr-2">
                                {{ item.word }}
                                {% if item.count > 1 %}
                                <span class="text-[10px] ml-1 px-1.5 py-0.5 rounded-full bg-emerald-200/50 dark:bg-emerald-800/50 text-emerald-800 dark:text-emerald-300">x{{ item.count }}</span>
                                {% endif %}
                            </span>
                            <i data-lucide="trending-up" class="w-3.5 h-3.5 shrink-0"></i>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-800/20 text-gray-400 text-xs italic text-center">
                            No significant positive drivers
                        </div>
                    {% endif %}
                </div>

                <!-- Negative Channel -->
                <div class="space-y-3">
                    <p class="text-xs font-bold text-rose-600 dark:text-rose-400 uppercase tracking-wider border-b border-rose-100 dark:border-rose-900 pb-1">Negative Drivers</p>
                    {% if weekly_outlook.pulse_words.negative %}
                        {% for item in weekly_outlook.pulse_words.negative %}
                        <div class="flex justify-between items-center px-4 py-2 rounded-xl bg-rose-50 dark:bg-rose-900/20 text-rose-700 dark:text-rose-400 border border-rose-100 dark:border-rose-800/30">
                            <span class="font-bold text-sm truncate pr-2">
                                {{ item.word }}
                                {% if item.count > 1 %}
                                <span class="text-[10px] ml-1 px-1.5 py-0.5 rounded-full bg-rose-200/50 dark:bg-rose-800/50 text-rose-800 dark:text-rose-300">x{{ item.count }}</span>
                                {% endif %}
                            </span>
                            <i data-lucide="trending-down" class="w-3.5 h-3.5 shrink-0"></i>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="px-4 py-3 rounded-xl bg-gray-50 dark:bg-gray-800/20 text-gray-400 text-xs italic text-center">
                            No significant negative drivers
                        </div>
                    {% endif %}
                </div>
            </div>
            <p class="text-xs text-gray-400 mt-6 italic">
                *These keywords represent the largest shift in public investor sentiment.<br>
                *이 키워드들은 대중 투자자들의 감성이 가장 크게 변화한 영역을 나타냅니다.
            </p>
        </div>
    </div>
    <!-- Glossary & FAQ -->
    <div class="grid md:grid-cols-3 gap-6 mt-6">
        <!-- 1. Signal & Valuation Guide -->
        <div class="bento-card p-6">
            <h3 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">Guide: Signal & Price<br>신호 및 가격 가이드</h3>
            <div class="space-y-4">
                <div class="flex items-start gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 shrink-0"></span>
                    <div>
                        <p class="text-[10px] font-bold text-gray-700 dark:text-gray-300">BUY / Good Value</p>
                        <p class="text-[10px] text-gray-500 leading-tight">positive sentiment or PBR &lt; 1.0 (Undervalued)<br><span class="opacity-70">긍정적 감성 또는 PBR 1배 미만 (저평가)</span></p>
                    </div>
                </div>
                <div class="flex items-start gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 mt-1.5 shrink-0"></span>
                    <div>
                        <p class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Fair Value</p>
                        <p class="text-[10px] text-gray-500 leading-tight">1.0 &le; PBR &le; 4.0 (Reasonable)<br><span class="opacity-70">기업 가치 대비 적정한 주가 수준</span></p>
                    </div>
                </div>
                <div class="flex items-start gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-amber-500 mt-1.5 shrink-0"></span>
                    <div>
                        <p class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Premium Price</p>
                        <p class="text-[10px] text-gray-500 leading-tight">PBR &gt; 4.0 (High Expectations)<br><span class="opacity-70">높은 성장 기대감이 가격에 반영됨</span></p>
                    </div>
                </div>
                <div class="flex items-start gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-rose-500 mt-1.5 shrink-0"></span>
                    <div>
                        <p class="text-[10px] font-bold text-gray-700 dark:text-gray-300">SELL / High Premium</p>
                        <p class="text-[10px] text-gray-500 leading-tight">Negative sentiment or PBR &gt; 8.0 (Risk)<br><span class="opacity-70">부정적 감성 또는 과열 구간 (주의 필요)</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Trigger Drivers -->
        <div class="bento-card p-6">
            <h3 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">Guide: Triggers<br>발생 원인 설명</h3>
            <div class="space-y-3">
                <div class="border-l-2 border-gray-200 dark:border-gray-700 pl-3">
                    <p class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Market Sentiment (시장 감성)</p>
                    <p class="text-[10px] text-gray-500 leading-tight">
                        General market tone drives the signal without a single dominant keyword.<br>
                        <span class="opacity-70">특정 키워드보다 시장 전반의 어조가 신호를 주도할 때 표시됩니다.</span>
                    </p>
                </div>
                <div class="border-l-2 border-gray-200 dark:border-gray-700 pl-3">
                    <p class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Sector Outlook (e.g. Semiconductor)</p>
                    <p class="text-[10px] text-gray-500 leading-tight">
                        Trends specific to the industry (e.g., chips, AI) are the main cause.<br>
                        <span class="opacity-70">반도체, AI 등 해당 산업군의 업황이 주된 원인일 때 표시됩니다.</span>
                    </p>
                </div>
                <div class="border-l-2 border-gray-200 dark:border-gray-700 pl-3">
                    <p class="text-[10px] font-bold text-gray-700 dark:text-gray-300">Holiday (휴장)</p>
                    <p class="text-[10px] text-gray-500 leading-tight">
                        Market is closed due to public holidays or exchange schedules.<br>
                        <span class="opacity-70">공휴일 또는 거래소 일정으로 인해 시장이 열리지 않습니다.</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- 3. FAQ -->
        <div class="bento-card p-6 bg-gray-50/50 dark:bg-gray-800/30 border-dashed">
            <h3 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">FAQ | 자주 묻는 질문</h3>
            <div class="space-y-4">
                <div>
                    <p class="text-[10px] font-bold text-gray-700 dark:text-gray-300 mb-1">Q. Why "Market Sentiment" for both Buy/Sell?</p>
                    <p class="text-[10px] font-bold text-gray-700 dark:text-gray-300 mb-1">Q. 왜 매수/매도 모두 '시장 감성'인가요?</p>
                    <p class="text-[10px] text-gray-500 leading-relaxed">
                        A. "Market Sentiment" indicates the overall mood. A positive score triggers Buy, negative triggers Sell. It's about the <strong>direction</strong> of the collective voice.<br>
                        <span class="opacity-70">A. '시장 감성'은 전체적인 분위기를 뜻합니다. 긍정적이면 매수, 부정적이면 매도 신호가 됩니다. 즉, 대중의 목소리가 향하는 <strong>방향</strong>이 핵심입니다.</span>
                    </p>
                </div>
                <div>
                    <p class="text-[10px] font-bold text-gray-700 dark:text-gray-300 mb-1">Q. What is "Analyzing news..."?</p>
                    <p class="text-[10px] text-gray-500 leading-relaxed">
                        A. Data is being processed or waiting for market open.<br>
                        <span class="opacity-70">A. 데이터가 처리 중이거나 장 시작을 대기 중인 상태입니다.</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- News Drill-down Modal -->
<div id="news-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
    <div class="bg-white dark:bg-gray-900 w-full max-w-2xl mx-4 rounded-3xl shadow-2xl transform scale-95 transition-transform duration-300 border border-gray-100 dark:border-gray-800" id="modal-content">
        <!-- Modal Header -->
        <div class="px-8 py-6 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
            <div>
                <h3 class="text-xl font-black text-gray-900 dark:text-gray-100" id="modal-date">YYYY-MM-DD</h3>
                <p class="text-sm text-gray-500">News Analysis & Evidence | <span class="opacity-70">뉴스 분석 및 근거</span></p>
            </div>
            <button onclick="closeNewsModal()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <i data-lucide="x" class="w-6 h-6 text-gray-500"></i>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-8 max-h-[60vh] overflow-y-auto" id="modal-body">
            <!-- Loading State -->
            <div class="flex flex-col items-center justify-center py-12 space-y-4">
                <i data-lucide="loader-2" class="w-8 h-8 text-indigo-500 animate-spin"></i>
                <p class="text-sm text-gray-400">Fetching news context...<br>뉴스 데이터를 불러오는 중...</p>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="px-8 py-5 border-t border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-800/20 rounded-b-3xl">
            <p class="text-xs text-gray-400 text-center">
                *News sentiment scores range from -1.0 (Negative) to +1.0 (Positive).<br>
                *뉴스 감성 점수는 -1.0 (부정) ~ +1.0 (긍정) 사이입니다.
            </p>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    lucide.createIcons();

    const stockCode = "{{ stock_code }}";

    function openNewsModal(dateStr) {
        // Remove trailing dates logic if needed, but dateStr should be YYYY-MM-DD
        // Clean up date string just in case
        const cleanDate = dateStr.trim();
        
        const modal = document.getElementById('news-modal');
        const modalContent = document.getElementById('modal-content');
        const modalDate = document.getElementById('modal-date');
        const modalBody = document.getElementById('modal-body');

        // Show Modal
        modal.classList.remove('hidden');
        // Small timeout for transition
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }, 10);

        modalDate.innerText = cleanDate;
        
        // Reset Body logic
        modalBody.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 space-y-4">
                <i data-lucide="loader-2" class="w-8 h-8 text-indigo-500 animate-spin"></i>
                <p class="text-sm text-gray-400">Fetching news context...<br>뉴스 데이터를 불러오는 중...</p>
                <p class="text-[10px] text-gray-300 font-mono">${stockCode} / ${cleanDate}</p>
            </div>
        `;
        lucide.createIcons();

        // Fetch Data
        fetch(`/analytics/api/news?stock_code=${stockCode}&date=${cleanDate}`)
            .then(res => res.json())
            .then(data => {
                if (!data.news || data.news.length === 0) {
                    modalBody.innerHTML = `
                        <div class="text-center py-12 px-6">
                            <div class="w-16 h-16 bg-indigo-50 dark:bg-indigo-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="waves" class="w-8 h-8 text-indigo-500"></i>
                            </div>
                            <h4 class="text-gray-900 dark:text-gray-100 font-bold mb-2">Sentiment Residue Phase</h4>
                            <p class="text-sm text-gray-500 leading-relaxed">
                                This prediction is driven by the <strong>Sentiment Residue</strong> logic. 
                                It reflects the lingering impact of previous major news events rather than a new standalone event on this specific date.
                            </p>
                            <div class="mt-4 p-3 rounded-xl bg-gray-50 dark:bg-gray-800/50 border border-gray-100 dark:border-gray-700">
                                <p class="text-xs text-gray-400">
                                    해당 일자의 예측은 과거 뉴스의 <strong>감성 잔류(Sentiment Residue)</strong> 로직에 의해 계산되었습니다. 
                                    당일 직접적인 뉴스 이벤트보다 가공된 이전 영향력이 지속되고 있는 구간입니다.
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    let html = '<div class="space-y-4">';
                    data.news.forEach(news => {
                        html += `
                            <a href="${news.url}" target="_blank" class="block p-4 rounded-2xl border border-gray-100 dark:border-gray-800 hover:border-indigo-200 dark:hover:border-indigo-800 hover:bg-indigo-50/30 dark:hover:bg-indigo-900/10 transition-all group">
                                <div class="flex justify-between items-start gap-4">
                                    <h4 class="font-bold text-gray-800 dark:text-gray-200 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors leading-snug text-sm flex-1">
                                        ${news.title}
                                    </h4>
                                    <span class="text-[10px] font-mono text-gray-400 whitespace-nowrap">${news.published_at}</span>
                                </div>
                                <div class="mt-2 flex items-center gap-2">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold 
                                        ${news.score > 0 ? 'bg-emerald-100 text-emerald-700' : (news.score < 0 ? 'bg-rose-100 text-rose-700' : 'bg-gray-100 text-gray-600')}">
                                        Score: ${news.score.toFixed(2)}
                                    </span>
                                    <span class="text-xs text-gray-400 truncate flex-1">${news.summary ? news.summary.substring(0, 60) + '...' : ''}</span>
                                    <i data-lucide="external-link" class="w-3 h-3 text-gray-300 group-hover:text-indigo-400"></i>
                                </div>
                            </a>
                        `;
                    });
                    html += '</div>';
                    modalBody.innerHTML = html;
                }
                lucide.createIcons();
            })
            .catch(err => {
                console.error(err);
                modalBody.innerHTML = `
                    <div class="text-center py-12 text-rose-500">
                        <i data-lucide="alert-circle" class="w-12 h-12 mx-auto mb-4"></i>
                        <p>Error loading news data.</p>
                    </div>
                `;
                lucide.createIcons();
            });
    }

    function closeNewsModal() {
        const modal = document.getElementById('news-modal');
        const modalContent = document.getElementById('modal-content');
        
        modal.classList.add('opacity-0');
        modalContent.classList.remove('scale-100');
        modalContent.classList.add('scale-95');
        
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
    
    // Close on backdrop click
    document.getElementById('news-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeNewsModal();
        }
    });
</script>
{% endblock %}
